function randomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}function shuffle(e){for(var t,i,n=e.length;0!==n;)i=Math.floor(Math.random()*n),n-=1,t=e[n],e[n]=e[i],e[i]=t;return e}function round(e,t){var i=Math.pow(10,t),n=e*i;return n=Math.round(n),n/=i}function onResize(){var e=document.getElementById("gameCanvas"),t=window.innerWidth/e.width,i=window.innerHeight/e.height,n=0|Math.min(t,i);n=0>=n?1:n;var s=[e.width*n,e.height*n],o=this.offset=[(window.innerWidth-s[0])/2,(window.innerHeight-s[1])/2],r=document.getElementById("stage"),a="translate("+o[0]+"px, "+o[1]+"px) scale("+n+")";r.style.transform=a,r.style.webkitTransform=a}var GAMEINFO;!function(e){e.TILESIZE=16,e.GAME_PIXEL_WIDTH=800,e.GAME_PIXEL_HEIGHT=448,e.GAME_TILE_WIDTH=e.GAME_PIXEL_WIDTH/e.TILESIZE,e.GAME_TILE_HEIGHT=e.GAME_PIXEL_HEIGHT/e.TILESIZE,e.TEXTLOG_TILE_HEIGHT=6,e.GAMESCREEN_TILE_WIDTH=.8*e.GAME_TILE_WIDTH,e.GAMESCREEN_TILE_HEIGHT=e.GAME_TILE_HEIGHT-e.TEXTLOG_TILE_HEIGHT,e.SIDEBAR_TILE_WIDTH=e.GAME_TILE_WIDTH-e.GAMESCREEN_TILE_WIDTH,e.SIDEBAR_TILE_HEIGHT=e.GAME_TILE_HEIGHT,e.TEXTLOG_TILE_WIDTH=e.GAME_TILE_WIDTH-e.SIDEBAR_TILE_WIDTH}(GAMEINFO||(GAMEINFO={}));var Input;!function(e){var t;!function(e){function t(e){return r[e]}function i(e){var t=h[e];return h[e]=!1,t}function n(){for(var e in h)h[e]=!1}function s(e){var t=e.which;r[t]=!0,a[t]&&(h[t]=!0),a[t]=!1}function o(e){var t=e.which;r[t]=!1,a[t]=!0}!function(e){e[e.A=65]="A",e[e.D=68]="D",e[e.W=87]="W",e[e.S=83]="S",e[e.LEFT=37]="LEFT",e[e.RIGHT=39]="RIGHT",e[e.UP=38]="UP",e[e.DOWN=40]="DOWN",e[e.ENTER=13]="ENTER",e[e.SPACE=32]="SPACE",e[e.NUM_1=49]="NUM_1",e[e.NUM_2=50]="NUM_2",e[e.NUM_3=51]="NUM_3",e[e.NUM_4=52]="NUM_4",e[e.NUM_5=53]="NUM_5",e[e.C=67]="C"}(e.KEY||(e.KEY={}));for(var r=(e.KEY,[]),a=[],h=[],l=0;256>l;l++)a[l]=!0;e.isDown=t,e.wasDown=i,e.clearInputQueue=n,e.keyDown=s,e.keyUp=o}(t=e.KB||(e.KB={}))}(Input||(Input={}));var Camera=function(){function e(e,t,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this.width=e,this.height=t,this.xOffset=i,this.yOffset=n}return e}(),TextLog;!function(e){function t(e){n[n.length]=e,n.length>=5&&s++}function i(e){e.fillStyle="#ffffff",e.font="12px Monospace";for(var t=n.length-1;t>=0&&t>=n.length-5;t--)e.fillText(n[t],2,GAMEINFO.GAME_PIXEL_HEIGHT-12*(n.length-1-t)-4)}var n=[],s=0;e.AddLog=t,e.DrawLog=i}(TextLog||(TextLog={}));var Point=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.x=e,this.y=t}return e}(),Dimension=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.w=e,this.h=t}return e}();Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,i=Object(this),n=i.length>>>0,s=arguments[1],o=0;n>o;o++)if(t=i[o],e.call(s,t,o,i))return t});var ImageCache;!function(e){function t(e){return i[e]}var i={};e.getTexture=t;var n,s={},o=0;!function(e){function t(e,t){s[e]=t,o++}function n(e){var t={counter:0,loadCount:0,callback:e},n=function(e){e.counter++===e.loadCount&&e.callback()};for(var r in s)i[r]=new Image,i[r].src=s[r],i[r].onload=n.bind(this,t),delete s[r];o=0}e.add=t,e.load=n}(n=e.Loader||(e.Loader={}))}(ImageCache||(ImageCache={}));var SpriteSheet=function(){function e(e,t,i,n,s,o){void 0===n&&(n=0),void 0===s&&(s=new Dimension(0,0)),void 0===o&&(o=new Point(0,0)),this.sprites=[],this.name=t,this.offset=o,this.subsheet=s,this.tileSize=i,this.gutter=n,this.image=ImageCache.getTexture(e),this.storeSprites()}return e.prototype.reColourize=function(e,t,i,n,s){for(var o=this.sprites[e].getContext("2d"),r=o.getImageData(0,0,this.tileSize,this.tileSize),a=0;a<this.tileSize*this.tileSize*4;a+=4)r.data[a]=t||r.data[a],r.data[a+1]=i||r.data[a+1],r.data[a+2]=n||r.data[a+2],r.data[a+3]=s||r.data[a+3];o.putImageData(r,0,0)},e.prototype.storeSprites=function(e){void 0===e&&(e=null),this.spritesPerRow=0===this.subsheet.w||0===this.subsheet.h?this.image.width/this.tileSize:this.subsheet.w,this.spritesPerCol=0===this.subsheet.w||0===this.subsheet.h?this.image.height/this.tileSize:this.subsheet.h;for(var t,i=0;i<this.spritesPerCol;i++)for(var n=0;n<this.spritesPerRow;n++)t=this.sprites[n+i*this.spritesPerRow]=document.createElement("canvas"),t.width=this.tileSize,t.height=this.tileSize,t.getContext("2d").drawImage(this.image,(this.tileSize+this.gutter)*n+this.offset.x,(this.tileSize+this.gutter)*i+this.offset.y,this.tileSize,this.tileSize,0,0,this.tileSize,this.tileSize)},e}(),SpriteSheetCache;!function(e){function t(e){n[e.name]=e}function i(e){return n[e]}var n={};e.storeSheet=t,e.spriteSheet=i}(SpriteSheetCache||(SpriteSheetCache={}));var AudioPool=function(){function e(e,t){void 0===t&&(t=1),this.pool=[],this.index=0,this.maxSize=t;for(var i=0;i<this.maxSize;i++)this.pool[i]=new Audio(e),this.pool[i].load()}return e.prototype.play=function(){(0==this.pool[this.index].currentTime||this.pool[this.index].ended)&&this.pool[this.index].play(),this.index=(this.index+1)%this.maxSize},e}(),__extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},ECS;!function(e){var t;!function(e){var t=function(){function e(e){this.name=e}return e}();e.Component=t;var i=function(e){function t(){e.call(this,"player"),this.value=!0}return __extends(t,e),t}(t);e.IsPlayer=i;var n=function(e){function t(){e.call(this,"enemy"),this.value=!0}return __extends(t,e),t}(t);e.IsEnemy=n;var s=function(e){function t(t){e.call(this,"name"),this.value=t}return __extends(t,e),t}(t);e.Name=s;var o=function(e){function t(){e.call(this,"timer"),this.value=0}return __extends(t,e),t}(t);e.TurnTimer=o;var r=function(e){function t(t){e.call(this,"sprite"),this.value=t}return __extends(t,e),t}(t);e.Sprite=r;var a=function(e){function t(){e.call(this,"pos"),this.value=new Point(0,0)}return __extends(t,e),t}(t);e.TilePos=a;var h=function(e){function t(){e.call(this,"movement"),this.value=new Point(0,0)}return __extends(t,e),t}(t);e.Movement=h;var l=function(e){function t(){e.call(this,"torch"),this.value=5}return __extends(t,e),t}(t);e.TorchStr=l;var c=function(e){function t(){e.call(this,"alive"),this.value=!0}return __extends(t,e),t}(t);e.Alive=c;var u=function(e){function t(t,i){e.call(this,"audio-"+t),this.value=new AudioPool(i,3)}return __extends(t,e),t}(t);e.Audio=u}(t=e.Components||(e.Components={}))}(ECS||(ECS={}));var ECS;!function(e){var t=function(){function e(){this.components={},e.autoID||(e.autoID=0),this.id=e.autoID++}return e.prototype.addComponent=function(e){this.components[e.name]=e,this[e.name]=e},e}();e.Entity=t}(ECS||(ECS={}));var ECS;!function(e){var t,i=12;!function(e){function t(e,t){var i=(e.pos.value,!1);return Input.KB.wasDown(Input.KB.KEY.LEFT)?(e.movement.value.x=-1,i=!0):Input.KB.wasDown(Input.KB.KEY.RIGHT)?(e.movement.value.x=1,i=!0):Input.KB.wasDown(Input.KB.KEY.UP)?(e.movement.value.y=-1,i=!0):Input.KB.wasDown(Input.KB.KEY.DOWN)&&(e.movement.value.y=1,i=!0),i&&e["audio-move"]&&(Input.KB.clearInputQueue(),e["audio-move"].value.play()),i}function n(e,t){4===t.cells[e.pos.value.x+e.movement.value.x][e.pos.value.y+e.movement.value.y].tileID&&(e.movement.value.y=e.movement.value.x=0)}function s(e,t){e.pos.value.y+=e.movement.value.y,e.pos.value.x+=e.movement.value.x,e.movement.value.y=e.movement.value.x=0,e.timer.value=0}function o(e,t){for(var i=0,n=t.visableCells;i<n.length;i++){var s=n[i];t.cells[s.x][s.y].visable=!1}t.visableCells=[];for(var o,r,a=e.pos.value,h=[],l=e.torch.value,c=-l;l>=c;c+=1)h[h.length]=new Point(c,-l),h[h.length]=new Point(c,l),h[h.length]=new Point(-l,c),h[h.length]=new Point(l,c);for(var u=0,d=0,f=0,p=round((a.x+.5)*GAMEINFO.TILESIZE,2),m=round((a.y+.5)*GAMEINFO.TILESIZE,2),E=0,v=h;E<v.length;E++){var I=v[E],w=p,y=m;o=round(I.x*GAMEINFO.TILESIZE,2),r=round(I.y*GAMEINFO.TILESIZE,2),u=Math.abs(o)>Math.abs(r)?Math.abs(o):Math.abs(r),d=round(o/u,2),f=round(r/u,2),0>d&&f>0?y-=1:d>0&&0>f&&(w-=1);for(var S=0,L=0,C=0;u>C&&(w=round(w+d,2),y=round(y+f,2),S=Math.floor(w/GAMEINFO.TILESIZE),L=Math.floor(y/GAMEINFO.TILESIZE),!t.cells[S]||!t.cells[S][L]||(t.cells[S][L].discovered||(t.cells[S][L].discovered=!0,t.render_m=t.render_mm=!0),t.cells[S][L].visable||(t.cells[S][L].visable=!0,t.visableCells[t.visableCells.length]=new Point(S,L)),3!==t.cells[S][L].tileID&&4!==t.cells[S][L].tileID));C++);}}function r(e,t){var n=t.pos.value.x+t.movement.value.x,s=t.pos.value.y+t.movement.value.y;(n<e.xOffset+i||n>=e.xOffset+e.width-i)&&(e.xOffset+=t.movement.value.x),(s<e.yOffset+i/2||s>=e.yOffset+e.height-i/2)&&(e.yOffset+=t.movement.value.y)}function a(e){Input.KB.isDown(Input.KB.KEY.LEFT)?e.xOffset+=-1:Input.KB.isDown(Input.KB.KEY.RIGHT)?e.xOffset+=1:Input.KB.isDown(Input.KB.KEY.UP)?e.yOffset+=-1:Input.KB.isDown(Input.KB.KEY.DOWN)&&(e.yOffset+=1)}function h(e,t,i){var n=0,s=0,o=0,r=0;n=e.pos.value.x-i.pos.value.x,s=e.pos.value.y-i.pos.value.y,Math.abs(n)<=6&&Math.abs(s)<=6?Math.abs(n)>Math.abs(s)?e.pos.value.x<i.pos.value.x?o=1:e.pos.value.x>i.pos.value.x&&(o=-1):e.pos.value.y<i.pos.value.y?r=1:e.pos.value.y>i.pos.value.y&&(r=-1):(0===randomInt(0,1)?o=1:r=-1,0===randomInt(0,1)&&(o*=-1,r*=-1)),t.walkable(t.cells[e.pos.value.x+o][e.pos.value.y+r])&&(e.movement.value.x+=o,e.movement.value.y+=r)}function l(e,t,i){e.pos.value.x!==i.pos.value.x||e.pos.value.y!==i.pos.value.y||e.player||e.alive.value!==!0||(e.alive.value=!1,e["audio-death"]&&e["audio-death"].value.play(),TextLog.AddLog(e.name.value+" got gatted!"))}e.InputControl=t,e.Collision=n,e.Movement=s,e.Vision=o,e.LockedCameraControl=r,e.FreeCameraControl=a,e.AIControl=h,e.StubCombat=l}(t=e.Systems||(e.Systems={}))}(ECS||(ECS={}));var ECS;!function(e){function t(e){return e.enemy&&e.alive&&e.alive.value===!0}e.isAliveEnemy=t}(ECS||(ECS={}));var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},TileSet=function(){function e(){}return e}(),Stat=function(){function e(){}return e}(),Items;!function(e){!function(e){e[e.HP=0]="HP",e[e.MP=1]="MP"}(e.ConsumableType||(e.ConsumableType={}));var t=(e.ConsumableType,function(){function e(e,t){}return e}());e.Consumable=t;var i=function(){function e(e,t,i){this.name=e,this.value=t,this.stats=i}return e}();e.Gear=i;var n=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.generate=function(e){return new t("Sword",100,[])},t}(i);e.Weapon=n;var s=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(i);e.Armor=s;var o=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(i);e.Ring=o;var r=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(i);e.Necklace=r}(Items||(Items={}));var Player=function(){function e(){}return e}(),Cell=function(){function e(e,t,i){void 0===e&&(e=0),void 0===t&&(t=[]),void 0===i&&(i=null),this.tileID=e,this.entityID=i,this.itemIDs=t,this.visable=!1,this.discovered=!1}return e}(),Level=function(){function e(e,t,i){this.redraw=!0,this.render_m=!0,this.render_mm=!0,this.cameraMode=!1,this.cells=[],this.visableCells=[],this._width=e,this._height=t,this.camera=i,this.EntityList=[],this.MiniMap=document.createElement("canvas"),this.MiniMap.width=e,this.MiniMap.height=t,this.MiniMap.getContext("2d").mozImageSmoothingEnabled=!1,this.MiniMap.getContext("2d").imageSmoothingEnabled=!1,this.renderCache=document.createElement("canvas"),this.renderCache.width=e*GAMEINFO.TILESIZE,this.renderCache.height=t*GAMEINFO.TILESIZE,this.renderCache.getContext("2d").mozImageSmoothingEnabled=!1,this.renderCache.getContext("2d").imageSmoothingEnabled=!1}return Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),e.prototype.snapCameraToLevel=function(){this.camera.xOffset<=0&&(this.camera.xOffset=0),this.camera.xOffset+this.camera.width>=this._width&&(this.camera.xOffset=this._width-this.camera.width),this.camera.yOffset<=0&&(this.camera.yOffset=0),this.camera.yOffset+this.camera.height>=this._height&&(this.camera.yOffset=this._height-this.camera.height)},e.prototype.partOfRoom=function(e){return 2===e.tileID},e.prototype.walkable=function(e){return 2===e.tileID||3===e.tileID||5===e.tileID||6===e.tileID},e.prototype.floodDiscover=function(e,t){var i=this._width-1,n=this._height-1,s=[],o=0;for(s[o]||(s[o]={x:0,y:0}),s[0].x=e,s[0].y=t,this.cells[e][t].discovered=!0;o>=0;)s[o]||(s[o]={x:0,y:0}),e=s[o].x,t=s[o].y,o--,e>0&&this.partOfRoom(this.cells[e-1][t])&&!this.cells[e-1][t].discovered&&(this.cells[e-1][t].discovered=!0,o++,s[o]||(s[o]={x:0,y:0}),s[o].x=e-1,s[o].y=t),i>e&&this.partOfRoom(this.cells[e+1][t])&&!this.cells[e+1][t].discovered&&(this.cells[e+1][t].discovered=!0,o++,s[o]||(s[o]={x:0,y:0}),s[o].x=e+1,s[o].y=t),t>0&&this.partOfRoom(this.cells[e][t-1])&&!this.cells[e][t-1].discovered&&(this.cells[e][t-1].discovered=!0,o++,s[o]||(s[o]={x:0,y:0}),s[o].x=e,s[o].y=t-1),n>t&&this.partOfRoom(this.cells[e][t+1])&&!this.cells[e][t+1].discovered&&(this.cells[e][t+1].discovered=!0,o++,s[o]||(s[o]={x:0,y:0}),s[o].x=e,s[o].y=t+1);for(var r=0;r<this._width;r++)for(var a=0;a<this._height;a++)if(2===this.cells[r][a].tileID&&this.cells[r][a].discovered)for(var h=-1;1>=h;h++)for(var l=-1;1>=l;l++)this.cells[r+h]&&this.cells[r+h][a+l]&&!this.cells[r+h][a+l].discovered&&(this.cells[r+h][a+l].discovered=!0)},e.prototype.floodFill=function(e,t,i,n){var s=this._width-1,o=this._height-1,r=[],a=0;for(r[a]||(r[a]={x:0,y:0}),r[0].x=e,r[0].y=t,this.cells[e][t].tileID=n;a>=0;)r[a]||(r[a]={x:0,y:0}),e=r[a].x,t=r[a].y,a--,e>0&&this.cells[e-1][t].tileID===i&&(this.cells[e-1][t].tileID=n,a++,r[a]||(r[a]={x:0,y:0}),r[a].x=e-1,r[a].y=t),s>e&&this.cells[e+1][t].tileID===i&&(this.cells[e+1][t].tileID=n,a++,r[a]||(r[a]={x:0,y:0}),r[a].x=e+1,r[a].y=t),t>0&&this.cells[e][t-1].tileID===i&&(this.cells[e][t-1].tileID=n,a++,r[a]||(r[a]={x:0,y:0}),r[a].x=e,r[a].y=t-1),o>t&&this.cells[e][t+1].tileID===i&&(this.cells[e][t+1].tileID=n,a++,r[a]||(r[a]={x:0,y:0}),r[a].x=e,r[a].y=t+1)},e.prototype.update=function(e){var t=this.EntityList.find(function(e,t,i){return e.player});if(Input.KB.wasDown(Input.KB.KEY.C)&&(this.cameraMode=!this.cameraMode,this.camera.xOffset=t.pos.value.x-this.camera.width/2,this.camera.yOffset=t.pos.value.y-this.camera.height/2,this.snapCameraToLevel(),Input.KB.clearInputQueue(),this.cameraMode?TextLog.AddLog("Free Camera Mode (Gameplay Paused)"):TextLog.AddLog("Locked Camera Mode (Gameplay Resumed)")),this.cameraMode)ECS.Systems.FreeCameraControl(this.camera),this.snapCameraToLevel(),this.redraw=!0;else{for(var i=0,n=this.EntityList;i<n.length;i++){var s=n[i];s.timer&&ECS.isAliveEnemy(s)&&s.timer.value<1e3||s.player&&s.timer.value<500?s.timer.value+=e:(s.player?ECS.Systems.InputControl(s,this):ECS.isAliveEnemy(s)&&ECS.Systems.AIControl(s,this,t),(0!==s.movement.value.x||0!==s.movement.value.y)&&(ECS.Systems.Collision(s,this),s.player&&(ECS.Systems.LockedCameraControl(this.camera,s),this.snapCameraToLevel()),ECS.Systems.Movement(s,this),this.redraw=!0),ECS.Systems.StubCombat(s,this,t))}this.redraw&&ECS.Systems.Vision(t,this)}},e.prototype.getTempColor=function(e){var t="ff00ff";switch(e){case 0:t="#111111";break;case 1:t="#aaaaaa";break;case 2:t="#222222";break;case 3:t="#ffffff";break;case 4:t="#999999";break;case 5:t="#00ff00";break;case 6:t="#0066FF";break;default:t="#ff00ff"}return t},e.prototype.render=function(e,t){for(var i=0,n=0;i<this._width;i++){for(var s=0,o=0;s<this._height;s++){var r=null;this.cells[i]&&this.cells[i][s]?(r=this.cells[i][s],r.discovered?r.visable?e.fillStyle=this.getTempColor(r.tileID):e.fillStyle=this.getTempColor(r.tileID):e.fillStyle="#000000"):e.fillStyle="#000000",r&&r.discovered&&16===t?e.drawImage(SpriteSheetCache.spriteSheet("tiles").sprites[this.cells[i][s].tileID],0,0,16,16,16*n,16*o,16,16):e.fillRect(n*t,o*t,t,t),o++}n++}},e.prototype.draw=function(e){this.render_m&&(this.render(this.renderCache.getContext("2d"),GAMEINFO.TILESIZE),this.render_m=!1),e.drawImage(this.renderCache,this.camera.xOffset*GAMEINFO.TILESIZE,this.camera.yOffset*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,0,0,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE)},e.prototype.drawMiniMap=function(e){this.render_mm&&(this.render(this.MiniMap.getContext("2d"),1),this.render_mm=!1),e.drawImage(this.MiniMap,0,0,this.MiniMap.width,this.MiniMap.height,GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width,0,this.MiniMap.width,this.MiniMap.height),e.strokeStyle="#FFF",e.lineWidth=2,e.strokeRect(GAMEINFO.GAME_PIXEL_WIDTH-this._width+this.camera.xOffset,this.camera.yOffset,this.camera.width,this.camera.height)},e.prototype.drawEntities=function(e){for(var t,i,n,s,o=0,r=this.EntityList;o<r.length;o++){var a=r[o];a.player&&(t=a,i=t.pos.value)}e.globalAlpha=.05;for(var h=0,l=this.visableCells;h<l.length;h++){var c=l[h];e.fillRect((c.x-this.camera.xOffset)*GAMEINFO.TILESIZE,(c.y-this.camera.yOffset)*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE)}e.globalAlpha=1;for(var u=0,d=0,f=this.EntityList;d<f.length;d++){var a=f[d];n=s=0,a.player?(u=0,e.fillStyle="#FF6600"):(n=t.pos.value.x-a.pos.value.x,s=t.pos.value.y-a.pos.value.y,u=1,e.fillStyle="#FF0000");var p=a.components.pos.value;(a.player||ECS.isAliveEnemy(a)&&this.cells[p.x][p.y].visable)&&(e.drawImage(a.sprite.value,0,0,16,16,p.x*GAMEINFO.TILESIZE-this.camera.xOffset*GAMEINFO.TILESIZE,p.y*GAMEINFO.TILESIZE-this.camera.yOffset*GAMEINFO.TILESIZE,16,16),e.fillRect(p.x+(GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width),p.y,1,1))}e.globalAlpha=1,this.redraw=!0},e}(),__extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},Cave=function(e){function t(t,i,n){e.call(this,t,i,n);for(var s=0;s<this._width;s++)for(var o=0;o<this._height;o++)void 0===this.cells[s]&&(this.cells[s]=[]),100*Math.random()<50||0===s||s===this._width-1||0===o||o===this._height-1?this.cells[s][o]=new Cell(0):this.cells[s][o]=new Cell(1);for(var s=5;s<this._width-5;s++)this.cells[s][this._height/2-1].tileID=1,this.cells[s][this._height/2].tileID=1,this.cells[s][this._height/2+1].tileID=1;for(var o=5;o<this._width-5;o++)this.cells[this._height/2-1][o].tileID=1,this.cells[this._height/2][o].tileID=1,this.cells[this._height/2+1][o].tileID=1;this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]);for(var s=1;s<this._width-1;s++)for(var o=1;o<this._height-1;o++){var r=this.cells[s][o],a=this.getLiveNeighbors(s,o);0===r.tileID&&2>a?r.tileID=1:1===r.tileID&&8===a&&(r.tileID=0)}for(var h=this._width/2,l=this._height/2;1!==this.cells[h][l].tileID;)h++;this.floodFill(h,l,1,2);for(var s=1;s<this._width-1;s++)for(var o=1;o<this._height-1;o++)1===this.cells[s][o].tileID&&(this.cells[s][o].tileID=0)}return __extends(t,e),t.prototype.getLiveNeighbors=function(e,t){for(var i=0,n=e-1;e+1>=n;n++)if(!(0>n||n>this._width))for(var s=t-1;t+1>=s;s++)0>s||s>this._height||(n!==e||s!==t)&&(i+=this.cells[n][s].tileID);return 8-i},t.prototype.cellularAutomata=function(e,t){for(var i=1;i<this._width-1;i++)for(var n=1;n<this._height-1;n++){var s=this.cells[i][n],o=this.getLiveNeighbors(i,n);if(1===s.tileID){for(var r in e)if(o===e[r]){s.tileID=0;break}}else{s.tileID=1;for(var r in t)if(o===t[r]){s.tileID=0;break}}}},t}(Level),WALL;!function(e){e[e.N=0]="N",e[e.E=1]="E",e[e.S=2]="S",e[e.W=3]="W"}(WALL||(WALL={}));var Room=function(){function e(){this.x=0,this.y=0,this.w=0,this.h=0,this.walls=[WALL.N,WALL.E,WALL.S,WALL.W],shuffle(this.walls)}return e.prototype.getRandomWall=function(){var e,t,i=this.walls.pop();return i===WALL.N?(e=this.x+Math.floor(this.w/2),t=this.y-1):i===WALL.S?(e=this.x+Math.floor(this.w/2),t=this.y+this.h):i===WALL.W?(e=this.x-1,t=this.y+Math.floor(this.h/2)):i===WALL.E&&(e=this.x+this.w,t=this.y+Math.floor(this.h/2)),{x:e,y:t,w:i}},e}(),__extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},Dungeon=function(e){function t(t,i,n){e.call(this,t,i,n),this.rooms=[];for(var s=0;s<this._width;s++)for(var o=0;o<this._height;o++)void 0===this.cells[s]&&(this.cells[s]=[]),this.cells[s][o]=new Cell(0);this.generate(32);var r=new ECS.Entity;r.addComponent(new ECS.Components.IsPlayer),r.addComponent(new ECS.Components.Name("Player")),r.addComponent(new ECS.Components.Sprite(SpriteSheetCache.spriteSheet("entities").sprites[0])),r.addComponent(new ECS.Components.TilePos),r.addComponent(new ECS.Components.TorchStr),r.addComponent(new ECS.Components.Alive),r.addComponent(new ECS.Components.Movement),r.addComponent(new ECS.Components.TurnTimer),r.addComponent(new ECS.Components.Audio("move","player_move.wav")),r.pos.value.x=this.entrance.x,r.pos.value.y=this.entrance.y,this.EntityList.push(r);for(var a=0;20>a;a++){var h=new ECS.Entity;h.addComponent(new ECS.Components.IsEnemy),a%2===0?(h.addComponent(new ECS.Components.Name("Rat")),h.addComponent(new ECS.Components.Sprite(SpriteSheetCache.spriteSheet("entities").sprites[1]))):(h.addComponent(new ECS.Components.Name("Bat")),h.addComponent(new ECS.Components.Sprite(SpriteSheetCache.spriteSheet("entities").sprites[2]))),h.addComponent(new ECS.Components.TilePos),h.addComponent(new ECS.Components.Movement),h.addComponent(new ECS.Components.TurnTimer),h.addComponent(new ECS.Components.Alive),h.addComponent(new ECS.Components.Audio("death","rat.wav"));do h.pos.value.x=randomInt(0,159),h.pos.value.y=randomInt(0,159);while(2!==this.cells[h.pos.value.x][h.pos.value.y].tileID);this.EntityList.push(h)}}return __extends(t,e),t.prototype.scan=function(e,t,i){var n=!0,s=t===WALL.W?e.x-1:e.x,o=t===WALL.N?e.y-1:e.y,r=!i||t!==WALL.W&&t!==WALL.E?e.w:e.w+1,a=!i||t!==WALL.N&&t!==WALL.S?e.h:e.h+1;r=t===WALL.N||t===WALL.S?r+1:r,a=t===WALL.W||t===WALL.E?a+1:a,i&&(s=t===WALL.E?s-1:s,o=t===WALL.S?o-1:o),(t===WALL.N||t===WALL.S)&&(s-=1),(t===WALL.W||t===WALL.E)&&(o-=1);for(var h=s;!(h>s+r)&&n;h++)for(var l=o;!(l>o+a)&&n;l++)n=n&&void 0!==this.cells[h]&&void 0!==this.cells[h][l]&&0===this.cells[h][l].tileID;return n},t.prototype.addRoom=function(e){for(var t=e.x;t<e.x+e.w;t++)for(var i=e.y;i<e.y+e.h;i++)this.cells[t][i].tileID=2},t.prototype.addTile=function(e,t){this.cells[e.x][e.y].tileID=t},t.prototype.makeRoom=function(e,t,i){void 0===e&&(e={x:-1,y:-1,w:-1}),void 0===t&&(t="R"),void 0===i&&(i=!1);var n=new Room;if(n.roomType=t,"R"===t){do n.w=randomInt(5,this._width/5),n.w=n.w%2===0?n.w-1:n.w,n.h=randomInt(5,this._height/5),n.h=n.h%2===0?n.h-1:n.h;while(n.w*n.h>this._width*this._height/4)}else"C"===t&&(n.w=e.w===WALL.N||e.w===WALL.S?3:randomInt(5,9),n.w=n.w%2===0?n.w-1:n.w,n.h=e.w===WALL.W||e.w===WALL.E?3:randomInt(5,9),n.h=n.h%2===0?n.h-1:n.h);if(n.x=e.w===WALL.N||e.w===WALL.S?e.x-Math.floor(n.w/2):e.x,n.x=e.w===WALL.W?n.x-(n.w-1):n.x,n.y=e.w===WALL.W||e.w===WALL.E?e.y-Math.floor(n.h/2):e.y,n.y=e.w===WALL.N?n.y-(n.h-1):n.y,i)switch(e.w){case WALL.N:n.y-=1;break;case WALL.S:n.y+=1;break;case WALL.W:n.x-=1;break;case WALL.E:n.x+=1}return n},t.prototype.generate=function(e){var t=0,i=0,n=[],s="",o="R",r=0,a=randomInt(0,100),h=this.makeRoom();h.x=randomInt(1,Math.floor(this._width-h.w)-1),h.y=randomInt(1,Math.floor(this._height-h.h)-1),n[n.length]=h,this.addRoom(h),this.rooms.push(h),t++,this.entrance=new Point(h.x+Math.floor(h.w/2),h.y+Math.floor(h.h/2)),this.addTile(this.entrance,5);for(var l;n.length>0&&e>t;){s=a>65+i?"C":"R";do{if(r>5||0===r){if(0===n[n.length-1].walls.length&&n.pop(),0===n.length)break;l=n[n.length-1].getRandomWall(),o=n[n.length-1].roomType}h=this.makeRoom(l,s,s!==o),r++}while(!this.scan(h,l.w,s!==o));if(r=0,0===n.length)break;s!==o&&this.addTile(l,3),n[n.length]=h,this.addRoom(h),"C"===s?i+=10:(this.rooms.push(h),t++,i-=10),o=n[n.length-1].roomType,s="",a=randomInt(0,100)}var c=this.rooms[this.rooms.length-1];this.addTile({x:c.x+Math.floor(c.w/2),y:c.y+Math.floor(c.h/2)},6);for(var u=0;u<this._width;u++)for(var d=0;d<this._height;d++)if(2===this.cells[u][d].tileID)for(var f=-1;1>=f;f++)for(var p=-1;1>=p;p++)this.cells[u+f]&&this.cells[u+f][d+p]&&0===this.cells[u+f][d+p].tileID&&(this.cells[u+f][d+p].tileID=4)},t}(Level),World=function(){function e(){this.levelHistory=[],this.redraw=!0,this.levelHistory[length]=this.currentLevel=new Dungeon(160,160,new Camera(GAMEINFO.GAMESCREEN_TILE_WIDTH,GAMEINFO.GAMESCREEN_TILE_HEIGHT));var e=this.currentLevel.EntityList.find(function(e,t,i){return e.player});ECS.Systems.Vision(e,this.currentLevel),this.currentLevel.camera.xOffset=this.currentLevel.entrance.x-this.currentLevel.camera.width/2,this.currentLevel.camera.yOffset=this.currentLevel.entrance.y-this.currentLevel.camera.height/2,this.currentLevel.snapCameraToLevel()}return e.prototype.update=function(e){this.currentLevel.redraw=this.redraw,this.currentLevel.update(e),this.redraw=this.currentLevel.redraw},e.prototype.draw=function(e){this.currentLevel.redraw&&(e.fillStyle="#ffffff",this.currentLevel.draw(e),e.fillStyle="#111111",e.fillRect(0,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,GAMEINFO.TEXTLOG_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAME_PIXEL_HEIGHT),TextLog.DrawLog(e),e.fillStyle="#111111",e.fillRect(GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),e.fillStyle="#ffffff",this.currentLevel.drawMiniMap(e),this.currentLevel.drawEntities(e),this.currentLevel.redraw=!1)},e}(),Game=function(){function e(e){this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=e,this.ctx=e.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=GAMEINFO.GAME_PIXEL_WIDTH,this.buffer.height=GAMEINFO.GAME_PIXEL_HEIGHT,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1}return e.prototype.init=function(){console.log("Initializing..."),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","tiles",16,0,new Dimension(7,1))),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","entities",16,0,new Dimension(3,1),new Point(0,16))),SpriteSheetCache.spriteSheet("entities").reColourize(0,245,200,25),SpriteSheetCache.spriteSheet("entities").reColourize(1,150,150,150),SpriteSheetCache.spriteSheet("entities").reColourize(2,200,1,1),SpriteSheetCache.spriteSheet("tiles").reColourize(4,50,50,50),SpriteSheetCache.spriteSheet("tiles").reColourize(3,140,100,60),SpriteSheetCache.spriteSheet("tiles").reColourize(2,25,25,25),this.world=new World,this.state="MainMenu",TextLog.AddLog("Arrow keys to move.")},e.prototype.update=function(e){switch(this.state){case"MainMenu":this.state="Game";break;case"Game":this.deltaPaused>0&&(e-=this.deltaPaused,0>e&&(e=0),this.deltaPaused=0),this.world.update(e);break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},e.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"Game":(this.clearScreen||this.world.redraw)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.bufferCtx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=!1),this.world.redraw&&(this.world.draw(this.bufferCtx),this.ctx.fillStyle="#ffffff",this.ctx.drawImage(this.buffer,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),this.world.redraw=!1);break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},e.prototype.render=function(){var e=performance.now(),t=e-this.then;this.then=e,this.update(t),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},e.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},e.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},e.prototype.pause=function(){"Game"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},e.prototype.unpause=function(){"GamePause"===this.state&&(this.state="Game",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0,this.world.redraw=!0)},e}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var e=new Game(document.getElementById("gameCanvas"));ImageCache.Loader.add("sheet","sheet1.png"),ImageCache.Loader.load(function(){e.init(),window.onblur=e.pause.bind(e),window.onfocus=e.unpause.bind(e),e.run()})};