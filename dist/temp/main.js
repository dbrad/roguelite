function randomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function shuffle(t){for(var e,i,s=t.length;0!==s;)i=Math.floor(Math.random()*s),s-=1,e=t[s],t[s]=t[i],t[i]=e;return t}function round(t,e){var i=Math.pow(10,e),s=t*i;return s=Math.round(s),s/=i}function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,s=0|Math.min(e,i);s=0>=s?1:s;var n=[t.width*s,t.height*s],r=this.offset=[(window.innerWidth-n[0])/2,(window.innerHeight-n[1])/2],h=document.getElementById("stage"),o="translate("+r[0]+"px, "+r[1]+"px) scale("+s+")";h.style.transform=o,h.style.webkitTransform=o}var GAMEINFO;!function(t){t.TILESIZE=16,t.GAME_PIXEL_WIDTH=800,t.GAME_PIXEL_HEIGHT=448,t.GAME_TILE_WIDTH=t.GAME_PIXEL_WIDTH/t.TILESIZE,t.GAME_TILE_HEIGHT=t.GAME_PIXEL_HEIGHT/t.TILESIZE,t.TEXTLOG_TILE_HEIGHT=6,t.GAMESCREEN_TILE_WIDTH=.8*t.GAME_TILE_WIDTH,t.GAMESCREEN_TILE_HEIGHT=t.GAME_TILE_HEIGHT-t.TEXTLOG_TILE_HEIGHT,t.SIDEBAR_TILE_WIDTH=t.GAME_TILE_WIDTH-t.GAMESCREEN_TILE_WIDTH,t.SIDEBAR_TILE_HEIGHT=t.GAME_TILE_HEIGHT,t.TEXTLOG_TILE_WIDTH=t.GAME_TILE_WIDTH-t.SIDEBAR_TILE_WIDTH}(GAMEINFO||(GAMEINFO={}));var Input;!function(t){var e;!function(t){function e(t){return r[t]}function i(t){var e=o[t];return o[t]=!1,e}function s(t){var e=t.which;r[e]=!0,h[e]&&(o[e]=!0),h[e]=!1}function n(t){var e=t.which;r[e]=!1,h[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE",t[t.NUM_1=49]="NUM_1",t[t.NUM_2=50]="NUM_2",t[t.NUM_3=51]="NUM_3",t[t.NUM_4=52]="NUM_4",t[t.NUM_5=53]="NUM_5"}(t.KEY||(t.KEY={}));for(var r=(t.KEY,[]),h=[],o=[],a=0;256>a;a++)h[a]=!0;t.isDown=e,t.wasDown=i,t.keyDown=s,t.keyUp=n}(e=t.KB||(t.KB={}))}(Input||(Input={}));var Camera=function(){function t(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this.width=t,this.height=e,this.xOffset=i,this.yOffset=s}return t}(),TextLog;!function(t){function e(t){s[s.length]=t,s.length>=5&&n++}function i(t){t.fillStyle="#ffffff",t.font="12px Monospace";for(var e=s.length-1;e>=0&&e>=s.length-5;e--)t.fillText(s[e],2,GAMEINFO.GAME_PIXEL_HEIGHT-12*(s.length-1-e)-4)}var s=[],n=0;t.AddLog=e,t.DrawLog=i}(TextLog||(TextLog={}));var Point=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t}(),Dimension=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.w=t,this.h=e}return t}();Array.prototype.find||(Array.prototype.find=function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,i=Object(this),s=i.length>>>0,n=arguments[1],r=0;s>r;r++)if(e=i[r],t.call(n,e,r,i))return e});var ImageCache;!function(t){function e(t){return i[t]}var i={};t.getTexture=e;var s,n={},r=0;!function(t){function e(t,e){n[t]=e,r++}function s(t){var e={counter:0,loadCount:0,callback:t},s=function(t){t.counter++===t.loadCount&&t.callback()};for(var h in n)i[h]=new Image,i[h].src=n[h],i[h].onload=s.bind(this,e),delete n[h];r=0}t.add=e,t.load=s}(s=t.Loader||(t.Loader={}))}(ImageCache||(ImageCache={}));var SpriteSheet=function(){function t(t,e,i,s,n,r){void 0===s&&(s=0),void 0===n&&(n=new Dimension(0,0)),void 0===r&&(r=new Point(0,0)),this.sprites=[],this.name=e,this.offset=r,this.subsheet=n,this.tileSize=i,this.gutter=s,this.image=ImageCache.getTexture(t),this.storeSprites()}return t.prototype.reColourize=function(t,e,i,s,n){for(var r=this.sprites[t].getContext("2d"),h=r.getImageData(0,0,this.tileSize,this.tileSize),o=0;o<this.tileSize*this.tileSize*4;o+=4)h.data[o]=e||h.data[o],h.data[o+1]=i||h.data[o+1],h.data[o+2]=s||h.data[o+2],h.data[o+3]=n||h.data[o+3];r.putImageData(h,0,0)},t.prototype.storeSprites=function(t){void 0===t&&(t=null),this.spritesPerRow=0===this.subsheet.w||0===this.subsheet.h?this.image.width/this.tileSize:this.subsheet.w,this.spritesPerCol=0===this.subsheet.w||0===this.subsheet.h?this.image.height/this.tileSize:this.subsheet.h;for(var e,i=0;i<this.spritesPerCol;i++)for(var s=0;s<this.spritesPerRow;s++)e=this.sprites[s+i*this.spritesPerRow]=document.createElement("canvas"),e.width=this.tileSize,e.height=this.tileSize,e.getContext("2d").drawImage(this.image,(this.tileSize+this.gutter)*s+this.offset.x,(this.tileSize+this.gutter)*i+this.offset.y,this.tileSize,this.tileSize,0,0,this.tileSize,this.tileSize)},t}(),SpriteSheetCache;!function(t){function e(t){s[t.name]=t}function i(t){return s[t]}var s={};t.storeSheet=e,t.spriteSheet=i}(SpriteSheetCache||(SpriteSheetCache={}));var AudioPool=function(){function t(t,e){void 0===e&&(e=1),this.pool=[],this.index=0,this.maxSize=e;for(var i=0;i<this.maxSize;i++)this.pool[i]=new Audio(t),this.pool[i].load()}return t.prototype.play=function(){(0==this.pool[this.index].currentTime||this.pool[this.index].ended)&&this.pool[this.index].play(),this.index=(this.index+1)%this.maxSize},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ECS;!function(t){var e;!function(t){var e=function(){function t(t){this.name=t}return t}();t.Component=e;var i=function(t){function e(){t.call(this,"player"),this.value=!0}return __extends(e,t),e}(e);t.IsPlayer=i;var s=function(t){function e(){t.call(this,"enemy"),this.value=!0}return __extends(e,t),e}(e);t.IsEnemy=s;var n=function(t){function e(){t.call(this,"pos"),this.value=new Point(0,0)}return __extends(e,t),e}(e);t.TilePos=n;var r=function(t){function e(){t.call(this,"torch"),this.value=5}return __extends(e,t),e}(e);t.TorchStr=r;var h=function(t){function e(){t.call(this,"alive"),this.value=!0}return __extends(e,t),e}(e);t.Alive=h}(e=t.Components||(t.Components={}))}(ECS||(ECS={}));var ECS;!function(t){var e=function(){function t(){this.components={},t.autoID||(t.autoID=0),this.id=t.autoID++}return t.prototype.addComponent=function(t){this.components[t.name]=t,this[t.name]=t},t}();t.Entity=e}(ECS||(ECS={}));var ECS;!function(t){var e,i=12;!function(t){function e(t,e){var s=t.pos.value,n=!1;return Input.KB.wasDown(Input.KB.KEY.LEFT)?(4!==e.cells[s.x-1][s.y].tileID&&(s.x--,s.x<e.camera.xOffset+i&&(e.camera.xOffset--,e.camera.xOffset<=0&&(e.camera.xOffset=0))),n=!0):Input.KB.wasDown(Input.KB.KEY.RIGHT)?(4!==e.cells[s.x+1][s.y].tileID&&(s.x++,s.x>=e.camera.xOffset+e.camera.width-i&&(e.camera.xOffset++,e.camera.xOffset+e.camera.width>=e.width&&(e.camera.xOffset=e.width-e.camera.width))),n=!0):Input.KB.wasDown(Input.KB.KEY.UP)?(4!==e.cells[s.x][s.y-1].tileID&&(s.y--,s.y<e.camera.yOffset+(i-3)&&(e.camera.yOffset--,e.camera.yOffset<=0&&(e.camera.yOffset=0))),n=!0):Input.KB.wasDown(Input.KB.KEY.DOWN)&&(4!==e.cells[s.x][s.y+1].tileID&&(s.y++,s.y>=e.camera.yOffset+e.camera.height-(i-3)&&(e.camera.yOffset++,e.camera.yOffset+e.camera.height>=e.height&&(e.camera.yOffset=e.height-e.camera.height))),n=!0),n}function s(t,e){for(var i=0,s=e.visableCells;i<s.length;i++){var n=s[i];e.cells[n.x][n.y].visable=!1}e.visableCells=[];for(var r,h,o=t.pos.value,a=[],l=t.torch.value,c=-l;l>=c;c+=1)a[a.length]=new Point(c,-l),a[a.length]=new Point(c,l),a[a.length]=new Point(-l,c),a[a.length]=new Point(l,c);for(var f=0,u=0,d=0,E=round((o.x+.5)*GAMEINFO.TILESIZE,2),I=round((o.y+.5)*GAMEINFO.TILESIZE,2),p=0,m=a;p<m.length;p++){var v=m[p],w=E,y=I;r=round(v.x*GAMEINFO.TILESIZE,2),h=round(v.y*GAMEINFO.TILESIZE,2),f=Math.abs(r)>Math.abs(h)?Math.abs(r):Math.abs(h),u=round(r/f,2),d=round(h/f,2),0>u&&d>0?y-=1:u>0&&0>d&&(w-=1);for(var L=0,g=0,S=0;f>S&&(w=round(w+u,2),y=round(y+d,2),L=Math.floor(w/GAMEINFO.TILESIZE),g=Math.floor(y/GAMEINFO.TILESIZE),!e.cells[L]||!e.cells[L][g]||(e.cells[L][g].discovered||(e.cells[L][g].discovered=!0,e.render_m=e.render_mm=!0),e.cells[L][g].visable||(e.cells[L][g].visable=!0,e.visableCells[e.visableCells.length]=new Point(L,g)),3!==e.cells[L][g].tileID&&4!==e.cells[L][g].tileID));S++);}}function n(t,e,i){var s=0,n=0,r=0,h=0;s=t.pos.value.x-i.pos.value.x,n=t.pos.value.y-i.pos.value.y,Math.abs(s)<=6&&Math.abs(n)<=6?Math.abs(s)>Math.abs(n)?t.pos.value.x<i.pos.value.x?r=1:t.pos.value.x>i.pos.value.x&&(r=-1):t.pos.value.y<i.pos.value.y?h=1:t.pos.value.y>i.pos.value.y&&(h=-1):(0===randomInt(0,1)?r=1:h=-1,0===randomInt(0,1)&&(r*=-1,h*=-1)),e.walkable(e.cells[t.pos.value.x+r][t.pos.value.y+h])&&(t.pos.value.x+=r,t.pos.value.y+=h)}function r(t,e,i){t.pos.value.x===i.pos.value.x&&t.pos.value.y===i.pos.value.y&&(t.alive.value=!1,TextLog.AddLog("Rat got gatted!"))}t.InputControl=e,t.Vision=s,t.AIControl=n,t.StubCombat=r}(e=t.Systems||(t.Systems={}))}(ECS||(ECS={}));var TileSet=function(){function t(){}return t}(),Item=function(){function t(){}return t}(),Cell=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=[]),void 0===i&&(i=null),this.tileID=t,this.entityID=i,this.itemIDs=e,this.visable=!1,this.discovered=!1}return t}(),Level=function(){function t(t,e,i){this.redraw=!0,this.render_m=!0,this.render_mm=!0,this.camThresh=12,this.timer=0,this.cells=[],this.visableCells=[],this._width=t,this._height=e,this.camera=i,this.EntityList=[],this.MiniMap=document.createElement("canvas"),this.MiniMap.width=t,this.MiniMap.height=e,this.MiniMap.getContext("2d").mozImageSmoothingEnabled=!1,this.MiniMap.getContext("2d").imageSmoothingEnabled=!1,this.renderCache=document.createElement("canvas"),this.renderCache.width=t*GAMEINFO.TILESIZE,this.renderCache.height=e*GAMEINFO.TILESIZE,this.renderCache.getContext("2d").mozImageSmoothingEnabled=!1,this.renderCache.getContext("2d").imageSmoothingEnabled=!1}return Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),t.prototype.snapCameraToLevel=function(){this.camera.xOffset<=0&&(this.camera.xOffset=0),this.camera.xOffset+this.camera.width>=this._width&&(this.camera.xOffset=this._width-this.camera.width),this.camera.yOffset<=0&&(this.camera.yOffset=0),this.camera.yOffset+this.camera.height>=this._height&&(this.camera.yOffset=this._height-this.camera.height)},t.prototype.partOfRoom=function(t){return 2===t.tileID},t.prototype.walkable=function(t){return 2===t.tileID||3===t.tileID||5===t.tileID||6===t.tileID},t.prototype.floodDiscover=function(t,e){var i=this._width-1,s=this._height-1,n=[],r=0;for(n[r]||(n[r]={x:0,y:0}),n[0].x=t,n[0].y=e,this.cells[t][e].discovered=!0;r>=0;)n[r]||(n[r]={x:0,y:0}),t=n[r].x,e=n[r].y,r--,t>0&&this.partOfRoom(this.cells[t-1][e])&&!this.cells[t-1][e].discovered&&(this.cells[t-1][e].discovered=!0,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t-1,n[r].y=e),i>t&&this.partOfRoom(this.cells[t+1][e])&&!this.cells[t+1][e].discovered&&(this.cells[t+1][e].discovered=!0,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t+1,n[r].y=e),e>0&&this.partOfRoom(this.cells[t][e-1])&&!this.cells[t][e-1].discovered&&(this.cells[t][e-1].discovered=!0,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t,n[r].y=e-1),s>e&&this.partOfRoom(this.cells[t][e+1])&&!this.cells[t][e+1].discovered&&(this.cells[t][e+1].discovered=!0,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t,n[r].y=e+1);for(var h=0;h<this._width;h++)for(var o=0;o<this._height;o++)if(2===this.cells[h][o].tileID&&this.cells[h][o].discovered)for(var a=-1;1>=a;a++)for(var l=-1;1>=l;l++)this.cells[h+a]&&this.cells[h+a][o+l]&&!this.cells[h+a][o+l].discovered&&(this.cells[h+a][o+l].discovered=!0)},t.prototype.floodFill=function(t,e,i,s){var n=this._width-1,r=this._height-1,h=[],o=0;for(h[o]||(h[o]={x:0,y:0}),h[0].x=t,h[0].y=e,this.cells[t][e].tileID=s;o>=0;)h[o]||(h[o]={x:0,y:0}),t=h[o].x,e=h[o].y,o--,t>0&&this.cells[t-1][e].tileID===i&&(this.cells[t-1][e].tileID=s,o++,h[o]||(h[o]={x:0,y:0}),h[o].x=t-1,h[o].y=e),n>t&&this.cells[t+1][e].tileID===i&&(this.cells[t+1][e].tileID=s,o++,h[o]||(h[o]={x:0,y:0}),h[o].x=t+1,h[o].y=e),e>0&&this.cells[t][e-1].tileID===i&&(this.cells[t][e-1].tileID=s,o++,h[o]||(h[o]={x:0,y:0}),h[o].x=t,h[o].y=e-1),r>e&&this.cells[t][e+1].tileID===i&&(this.cells[t][e+1].tileID=s,o++,h[o]||(h[o]={x:0,y:0}),h[o].x=t,h[o].y=e+1)},t.prototype.update=function(t){if(this.timer+=t,!(this.timer<75)){var e=this.EntityList.find(function(t,e,i){return t.player}),i=(e.pos.value,this.EntityList.filter(function(t,e,i){return t.enemy&&t.alive&&t.alive.value===!0}));if(ECS.Systems.InputControl(e,this)){for(var s=0,n=i;s<n.length;s++){var r=n[s];ECS.Systems.AIControl(r,this,e),ECS.Systems.StubCombat(r,this,e)}ECS.Systems.Vision(e,this),this.redraw=!0,this.timer=0}}},t.prototype.getTempColor=function(t){var e="ff00ff";switch(t){case 0:e="#111111";break;case 1:e="#aaaaaa";break;case 2:e="#222222";break;case 3:e="#ffffff";break;case 4:e="#999999";break;case 5:e="#00ff00";break;case 6:e="#0066FF";break;default:e="#ff00ff"}return e},t.prototype.render=function(t,e){for(var i=0,s=0;i<this._width;i++){for(var n=0,r=0;n<this._height;n++){var h=null;this.cells[i]&&this.cells[i][n]?(h=this.cells[i][n],h.discovered?h.visable?t.fillStyle=this.getTempColor(h.tileID):t.fillStyle=this.getTempColor(h.tileID):t.fillStyle="#000000"):t.fillStyle="#000000",h&&h.discovered&&16===e?t.drawImage(SpriteSheetCache.spriteSheet("tiles").sprites[this.cells[i][n].tileID],0,0,16,16,16*s,16*r,16,16):t.fillRect(s*e,r*e,e,e),r++}s++}},t.prototype.draw=function(t){this.render_m&&(this.render(this.renderCache.getContext("2d"),GAMEINFO.TILESIZE),this.render_m=!1),t.drawImage(this.renderCache,this.camera.xOffset*GAMEINFO.TILESIZE,this.camera.yOffset*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,0,0,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE)},t.prototype.drawMiniMap=function(t){this.render_mm&&(this.render(this.MiniMap.getContext("2d"),1),this.render_mm=!1),t.drawImage(this.MiniMap,0,0,this.MiniMap.width,this.MiniMap.height,GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width,0,this.MiniMap.width,this.MiniMap.height),t.strokeStyle="#FFF",t.lineWidth=2,t.strokeRect(GAMEINFO.GAME_PIXEL_WIDTH-this._width+this.camera.xOffset,this.camera.yOffset,this.camera.width,this.camera.height)},t.prototype.drawEntities=function(t){for(var e,i,s,n,r=0,h=this.EntityList;r<h.length;r++){var o=h[r];o.player&&(e=o,i=e.pos.value)}t.globalAlpha=.05;for(var a=0,l=this.visableCells;a<l.length;a++){var c=l[a];t.fillRect((c.x-this.camera.xOffset)*GAMEINFO.TILESIZE,(c.y-this.camera.yOffset)*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE)}t.globalAlpha=1;for(var f=0,u=0,d=this.EntityList;u<d.length;u++){var o=d[u];s=n=0,o.player?(f=0,t.fillStyle="#FF6600"):(s=e.pos.value.x-o.pos.value.x,n=e.pos.value.y-o.pos.value.y,f=1,t.fillStyle="#FF0000");var E=o.components.pos.value;(o.player||o.enemy&&o.alive&&o.alive.value===!0&&this.cells[E.x][E.y].visable)&&(t.drawImage(SpriteSheetCache.spriteSheet("entities").sprites[f],0,0,16,16,E.x*GAMEINFO.TILESIZE-this.camera.xOffset*GAMEINFO.TILESIZE,E.y*GAMEINFO.TILESIZE-this.camera.yOffset*GAMEINFO.TILESIZE,16,16),t.fillRect(E.x+(GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width),E.y,1,1))}t.globalAlpha=1,this.redraw=!0},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Cave=function(t){function e(e,i,s){t.call(this,e,i,s);for(var n=0;n<this._width;n++)for(var r=0;r<this._height;r++)void 0===this.cells[n]&&(this.cells[n]=[]),100*Math.random()<50||0===n||n===this._width-1||0===r||r===this._height-1?this.cells[n][r]=new Cell(0):this.cells[n][r]=new Cell(1);for(var n=5;n<this._width-5;n++)this.cells[n][this._height/2-1].tileID=1,this.cells[n][this._height/2].tileID=1,this.cells[n][this._height/2+1].tileID=1;for(var r=5;r<this._width-5;r++)this.cells[this._height/2-1][r].tileID=1,this.cells[this._height/2][r].tileID=1,this.cells[this._height/2+1][r].tileID=1;this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]);for(var n=1;n<this._width-1;n++)for(var r=1;r<this._height-1;r++){var h=this.cells[n][r],o=this.getLiveNeighbors(n,r);0===h.tileID&&2>o?h.tileID=1:1===h.tileID&&8===o&&(h.tileID=0)}for(var a=this._width/2,l=this._height/2;1!==this.cells[a][l].tileID;)a++;this.floodFill(a,l,1,2);for(var n=1;n<this._width-1;n++)for(var r=1;r<this._height-1;r++)1===this.cells[n][r].tileID&&(this.cells[n][r].tileID=0)}return __extends(e,t),e.prototype.getLiveNeighbors=function(t,e){for(var i=0,s=t-1;t+1>=s;s++)if(!(0>s||s>this._width))for(var n=e-1;e+1>=n;n++)0>n||n>this._height||(s!==t||n!==e)&&(i+=this.cells[s][n].tileID);return 8-i},e.prototype.cellularAutomata=function(t,e){for(var i=1;i<this._width-1;i++)for(var s=1;s<this._height-1;s++){var n=this.cells[i][s],r=this.getLiveNeighbors(i,s);if(1===n.tileID){for(var h in t)if(r===t[h]){n.tileID=0;break}}else{n.tileID=1;for(var h in e)if(r===e[h]){n.tileID=0;break}}}},e}(Level),WALL;!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W"}(WALL||(WALL={}));var Room=function(){function t(){this.x=0,this.y=0,this.w=0,this.h=0,this.walls=[WALL.N,WALL.E,WALL.S,WALL.W],shuffle(this.walls)}return t.prototype.getRandomWall=function(){var t,e,i=this.walls.pop();return i===WALL.N?(t=this.x+Math.floor(this.w/2),e=this.y-1):i===WALL.S?(t=this.x+Math.floor(this.w/2),e=this.y+this.h):i===WALL.W?(t=this.x-1,e=this.y+Math.floor(this.h/2)):i===WALL.E&&(t=this.x+this.w,e=this.y+Math.floor(this.h/2)),{x:t,y:e,w:i}},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Dungeon=function(t){function e(e,i,s){t.call(this,e,i,s),this.rooms=[];for(var n=0;n<this._width;n++)for(var r=0;r<this._height;r++)void 0===this.cells[n]&&(this.cells[n]=[]),this.cells[n][r]=new Cell(0);this.generate(32);var h=new ECS.Entity;h.addComponent(new ECS.Components.IsPlayer),h.addComponent(new ECS.Components.TilePos),h.addComponent(new ECS.Components.TorchStr),h.addComponent(new ECS.Components.Alive),h.pos.value.x=this.entrance.x,h.pos.value.y=this.entrance.y,this.EntityList.push(h);for(var o=0;20>o;o++){var a=new ECS.Entity;a.addComponent(new ECS.Components.IsEnemy),a.addComponent(new ECS.Components.TilePos),a.addComponent(new ECS.Components.Alive);do a.pos.value.x=randomInt(0,159),a.pos.value.y=randomInt(0,159);while(2!==this.cells[a.pos.value.x][a.pos.value.y].tileID);this.EntityList.push(a)}}return __extends(e,t),e.prototype.scan=function(t,e,i){var s=!0,n=e===WALL.W?t.x-1:t.x,r=e===WALL.N?t.y-1:t.y,h=!i||e!==WALL.W&&e!==WALL.E?t.w:t.w+1,o=!i||e!==WALL.N&&e!==WALL.S?t.h:t.h+1;h=e===WALL.N||e===WALL.S?h+1:h,o=e===WALL.W||e===WALL.E?o+1:o,i&&(n=e===WALL.E?n-1:n,r=e===WALL.S?r-1:r),(e===WALL.N||e===WALL.S)&&(n-=1),(e===WALL.W||e===WALL.E)&&(r-=1);for(var a=n;!(a>n+h)&&s;a++)for(var l=r;!(l>r+o)&&s;l++)s=s&&void 0!==this.cells[a]&&void 0!==this.cells[a][l]&&0===this.cells[a][l].tileID;return s},e.prototype.addRoom=function(t){for(var e=t.x;e<t.x+t.w;e++)for(var i=t.y;i<t.y+t.h;i++)this.cells[e][i].tileID=2},e.prototype.addTile=function(t,e){this.cells[t.x][t.y].tileID=e},e.prototype.makeRoom=function(t,e,i){void 0===t&&(t={x:-1,y:-1,w:-1}),void 0===e&&(e="R"),void 0===i&&(i=!1);var s=new Room;if(s.roomType=e,"R"===e){do s.w=randomInt(5,this._width/5),s.w=s.w%2===0?s.w-1:s.w,s.h=randomInt(5,this._height/5),s.h=s.h%2===0?s.h-1:s.h;while(s.w*s.h>this._width*this._height/4)}else"C"===e&&(s.w=t.w===WALL.N||t.w===WALL.S?3:randomInt(5,9),s.w=s.w%2===0?s.w-1:s.w,s.h=t.w===WALL.W||t.w===WALL.E?3:randomInt(5,9),s.h=s.h%2===0?s.h-1:s.h);if(s.x=t.w===WALL.N||t.w===WALL.S?t.x-Math.floor(s.w/2):t.x,s.x=t.w===WALL.W?s.x-(s.w-1):s.x,s.y=t.w===WALL.W||t.w===WALL.E?t.y-Math.floor(s.h/2):t.y,s.y=t.w===WALL.N?s.y-(s.h-1):s.y,i)switch(t.w){case WALL.N:s.y-=1;break;case WALL.S:s.y+=1;break;case WALL.W:s.x-=1;break;case WALL.E:s.x+=1}return s},e.prototype.generate=function(t){var e=0,i=0,s=[],n="",r="R",h=0,o=randomInt(0,100),a=this.makeRoom();a.x=randomInt(1,Math.floor(this._width-a.w)-1),a.y=randomInt(1,Math.floor(this._height-a.h)-1),s[s.length]=a,this.addRoom(a),this.rooms.push(a),e++,this.entrance=new Point(a.x+Math.floor(a.w/2),a.y+Math.floor(a.h/2)),this.addTile(this.entrance,5);for(var l;s.length>0&&t>e;){n=o>65+i?"C":"R";do{if(h>5||0===h){if(0===s[s.length-1].walls.length&&s.pop(),0===s.length)break;l=s[s.length-1].getRandomWall(),r=s[s.length-1].roomType}a=this.makeRoom(l,n,n!==r),h++}while(!this.scan(a,l.w,n!==r));if(h=0,0===s.length)break;n!==r&&this.addTile(l,3),s[s.length]=a,this.addRoom(a),"C"===n?i+=10:(this.rooms.push(a),e++,i-=10),r=s[s.length-1].roomType,n="",o=randomInt(0,100)}var c=this.rooms[this.rooms.length-1];this.addTile({x:c.x+Math.floor(c.w/2),y:c.y+Math.floor(c.h/2)},6);for(var f=0;f<this._width;f++)for(var u=0;u<this._height;u++)if(2===this.cells[f][u].tileID)for(var d=-1;1>=d;d++)for(var E=-1;1>=E;E++)this.cells[f+d]&&this.cells[f+d][u+E]&&0===this.cells[f+d][u+E].tileID&&(this.cells[f+d][u+E].tileID=4)},e}(Level),World=function(){function t(){this.levelHistory=[],this.redraw=!0,this.levelHistory[length]=this.currentLevel=new Dungeon(160,160,new Camera(GAMEINFO.GAMESCREEN_TILE_WIDTH,GAMEINFO.GAMESCREEN_TILE_HEIGHT));var t=this.currentLevel.EntityList.find(function(t,e,i){return t.player});ECS.Systems.Vision(t,this.currentLevel),this.currentLevel.camera.xOffset=this.currentLevel.entrance.x-this.currentLevel.camera.width/2,this.currentLevel.camera.yOffset=this.currentLevel.entrance.y-this.currentLevel.camera.height/2,this.currentLevel.snapCameraToLevel()}return t.prototype.update=function(t){this.currentLevel.redraw=this.redraw,this.currentLevel.update(t),this.redraw=this.currentLevel.redraw},t.prototype.draw=function(t){this.currentLevel.redraw&&(t.fillStyle="#ffffff",this.currentLevel.draw(t),t.fillStyle="#111111",t.fillRect(0,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,GAMEINFO.TEXTLOG_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAME_PIXEL_HEIGHT),TextLog.DrawLog(t),t.fillStyle="#111111",t.fillRect(GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),t.fillStyle="#ffffff",this.currentLevel.drawMiniMap(t),this.currentLevel.drawEntities(t),this.currentLevel.redraw=!1)},t}(),Game=function(){function t(t){this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=GAMEINFO.GAME_PIXEL_WIDTH,this.buffer.height=GAMEINFO.GAME_PIXEL_HEIGHT,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1}return t.prototype.init=function(){console.log("Initializing..."),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","tiles",16,0,new Dimension(7,1))),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","entities",16,0,new Dimension(2,1),new Point(0,16))),SpriteSheetCache.spriteSheet("entities").reColourize(0,245,200,25),SpriteSheetCache.spriteSheet("entities").reColourize(1,150,150,150),SpriteSheetCache.spriteSheet("tiles").reColourize(4,75,75,75),SpriteSheetCache.spriteSheet("tiles").reColourize(3,140,100,60),this.world=new World,this.state="MainMenu",TextLog.AddLog("Arrow keys to move.")},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="Game";break;case"Game":this.deltaPaused>0&&(t-=this.deltaPaused,0>t&&(t=0),this.deltaPaused=0),this.world.update(t);break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"Game":(this.clearScreen||this.world.redraw)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.bufferCtx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=!1),this.world.redraw&&(this.world.draw(this.bufferCtx),this.ctx.fillStyle="#ffffff",this.ctx.drawImage(this.buffer,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),this.world.redraw=!1);break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t.prototype.pause=function(){"Game"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},t.prototype.unpause=function(){"GamePause"===this.state&&(this.state="Game",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0,this.world.redraw=!0)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var t=new Game(document.getElementById("gameCanvas"));ImageCache.Loader.add("sheet","sheet1.png"),ImageCache.Loader.load(function(){t.init(),window.onblur=t.pause.bind(t),window.onfocus=t.unpause.bind(t),t.run()})};