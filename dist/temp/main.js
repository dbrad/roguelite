function randomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function shuffle(t){for(var e,i,s=t.length;0!==s;)i=Math.floor(Math.random()*s),s-=1,e=t[s],t[s]=t[i],t[i]=e;return t}function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,s=0|Math.min(e,i);s=0>=s?1:s;var h=[t.width*s,t.height*s],a=this.offset=[(window.innerWidth-h[0])/2,(window.innerHeight-h[1])/2],n=document.getElementById("stage"),r="translate("+a[0]+"px, "+a[1]+"px) scale("+s+")";n.style.transform=r,n.style.webkitTransform=r}var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},ECS;!function(t){var e=function(){function t(){this.components={},t.autoID||(t.autoID=0),this.id=t.autoID++}return t.prototype.addComponent=function(t){this.components[t.name]=t,this[t.name]=t},t}();t.Entity=e;var i;!function(t){var e=function(){function t(t){this.name=t}return t}();t.Component=e;var i=function(t){function e(){t.call(this,"player"),this.value=!0}return __extends(e,t),e}(e);t.IsPlayer=i;var s=function(t){function e(){t.call(this,"enemy"),this.value=!0}return __extends(e,t),e}(e);t.IsEnemy=s;var h=function(t){function e(){t.call(this,"pos"),this.value={x:0,y:0}}return __extends(e,t),e}(e);t.TilePos=h}(i=t.Components||(t.Components={}))}(ECS||(ECS={}));var GAMEINFO;!function(t){t.TILESIZE=16,t.GAME_PIXEL_WIDTH=800,t.GAME_PIXEL_HEIGHT=448,t.GAME_TILE_WIDTH=t.GAME_PIXEL_WIDTH/t.TILESIZE,t.GAME_TILE_HEIGHT=t.GAME_PIXEL_HEIGHT/t.TILESIZE,t.TEXTLOG_TILE_HEIGHT=6,t.GAMESCREEN_TILE_WIDTH=.8*t.GAME_TILE_WIDTH,t.GAMESCREEN_TILE_HEIGHT=t.GAME_TILE_HEIGHT-t.TEXTLOG_TILE_HEIGHT,t.SIDEBAR_TILE_WIDTH=t.GAME_TILE_WIDTH-t.GAMESCREEN_TILE_WIDTH,t.SIDEBAR_TILE_HEIGHT=t.GAME_TILE_HEIGHT,t.TEXTLOG_TILE_WIDTH=t.GAME_TILE_WIDTH-t.SIDEBAR_TILE_WIDTH}(GAMEINFO||(GAMEINFO={}));var TileSet=function(){function t(){}return t}(),Item=function(){function t(){}return t}(),Cell=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=[]),void 0===i&&(i=null),this.tileID=t,this.entityID=i,this.itemIDs=e,this.visable=!0,this.discovered=!1}return t}(),Camera=function(){function t(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this.width=t,this.height=e,this.xOffset=i,this.yOffset=s}return t}(),Level=function(){function t(t,e,i){this.redraw=!0,this.render_m=!0,this.render_mm=!0,this.camThresh=12,this.cells=[],this.width=t,this.height=e,this.camera=i,this.EntityList=[],this.MiniMap=document.createElement("canvas"),this.MiniMap.width=t,this.MiniMap.height=e,this.MiniMap.getContext("2d").mozImageSmoothingEnabled=!1,this.MiniMap.getContext("2d").imageSmoothingEnabled=!1,this.renderCache=document.createElement("canvas"),this.renderCache.width=t*GAMEINFO.TILESIZE,this.renderCache.height=e*GAMEINFO.TILESIZE,this.renderCache.getContext("2d").mozImageSmoothingEnabled=!1,this.renderCache.getContext("2d").imageSmoothingEnabled=!1}return t.prototype.snapCameraToLevel=function(){this.camera.xOffset<=0&&(this.camera.xOffset=0),this.camera.xOffset+this.camera.width>=this.width&&(this.camera.xOffset=this.width-this.camera.width),this.camera.yOffset<=0&&(this.camera.yOffset=0),this.camera.yOffset+this.camera.height>=this.height&&(this.camera.yOffset=this.height-this.camera.height)},t.prototype.partOfRoom=function(t){return 2===t.tileID},t.prototype.floodDiscover=function(t,e){var i=this.width-1,s=this.height-1,h=[],a=0;for(h[a]||(h[a]={x:0,y:0}),h[0].x=t,h[0].y=e,this.cells[t][e].discovered=!0;a>=0;)h[a]||(h[a]={x:0,y:0}),t=h[a].x,e=h[a].y,a--,t>0&&this.partOfRoom(this.cells[t-1][e])&&!this.cells[t-1][e].discovered&&(this.cells[t-1][e].discovered=!0,a++,h[a]||(h[a]={x:0,y:0}),h[a].x=t-1,h[a].y=e),i>t&&this.partOfRoom(this.cells[t+1][e])&&!this.cells[t+1][e].discovered&&(this.cells[t+1][e].discovered=!0,a++,h[a]||(h[a]={x:0,y:0}),h[a].x=t+1,h[a].y=e),e>0&&this.partOfRoom(this.cells[t][e-1])&&!this.cells[t][e-1].discovered&&(this.cells[t][e-1].discovered=!0,a++,h[a]||(h[a]={x:0,y:0}),h[a].x=t,h[a].y=e-1),s>e&&this.partOfRoom(this.cells[t][e+1])&&!this.cells[t][e+1].discovered&&(this.cells[t][e+1].discovered=!0,a++,h[a]||(h[a]={x:0,y:0}),h[a].x=t,h[a].y=e+1);for(var n=0;n<this.width;n++)for(var r=0;r<this.height;r++)if(2===this.cells[n][r].tileID&&this.cells[n][r].discovered)for(var o=-1;1>=o;o++)for(var l=-1;1>=l;l++)this.cells[n+o]&&this.cells[n+o][r+l]&&!this.cells[n+o][r+l].discovered&&(this.cells[n+o][r+l].discovered=!0)},t.prototype.floodFill=function(t,e,i,s){var h=this.width-1,a=this.height-1,n=[],r=0;for(n[r]||(n[r]={x:0,y:0}),n[0].x=t,n[0].y=e,this.cells[t][e].tileID=s;r>=0;)n[r]||(n[r]={x:0,y:0}),t=n[r].x,e=n[r].y,r--,t>0&&this.cells[t-1][e].tileID===i&&(this.cells[t-1][e].tileID=s,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t-1,n[r].y=e),h>t&&this.cells[t+1][e].tileID===i&&(this.cells[t+1][e].tileID=s,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t+1,n[r].y=e),e>0&&this.cells[t][e-1].tileID===i&&(this.cells[t][e-1].tileID=s,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t,n[r].y=e-1),a>e&&this.cells[t][e+1].tileID===i&&(this.cells[t][e+1].tileID=s,r++,n[r]||(n[r]={x:0,y:0}),n[r].x=t,n[r].y=e+1)},t.prototype.getWidth=function(){return this.width},t.prototype.getHeight=function(){return this.height},t.prototype.update=function(){var t=1,e=this.EntityList[0],i=e.pos.value;Input.KB.wasDown(Input.KB.KEY.LEFT)?(4!==this.cells[i.x-1][i.y].tileID&&(i.x--,i.x<this.camera.xOffset+this.camThresh&&(this.camera.xOffset-=t,this.camera.xOffset<=0&&(this.camera.xOffset=0))),this.redraw=!0):Input.KB.wasDown(Input.KB.KEY.RIGHT)&&(4!==this.cells[i.x+1][i.y].tileID&&(i.x++,i.x>=this.camera.xOffset+this.camera.width-this.camThresh&&(this.camera.xOffset+=t,this.camera.xOffset+this.camera.width>=this.width&&(this.camera.xOffset=this.width-this.camera.width))),this.redraw=!0),Input.KB.wasDown(Input.KB.KEY.UP)?(4!==this.cells[i.x][i.y-1].tileID&&(i.y--,i.y<this.camera.yOffset+this.camThresh/2&&(this.camera.yOffset-=t,this.camera.yOffset<=0&&(this.camera.yOffset=0))),this.redraw=!0):Input.KB.wasDown(Input.KB.KEY.DOWN)&&(4!==this.cells[i.x][i.y+1].tileID&&(i.y++,i.y>=this.camera.yOffset+this.camera.height-this.camThresh/2&&(this.camera.yOffset+=t,this.camera.yOffset+this.camera.height>=this.height&&(this.camera.yOffset=this.height-this.camera.height))),this.redraw=!0),this.cells[i.x][i.y].discovered||(this.floodDiscover(i.x,i.y),this.render_m=this.render_mm=!0)},t.prototype.getTempColor=function(t){var e="ff00ff";switch(t){case 0:e="#111111";break;case 1:e="#aaaaaa";break;case 2:e="#222222";break;case 3:e="#ffffff";break;case 4:e="#999999";break;case 5:e="#00ff00";break;case 6:e="#0066FF";break;default:e="#ff00ff"}return e},t.prototype.render=function(t,e){for(var i=0,s=0;i<this.width;i++){for(var h=0,a=0;h<this.height;h++){if(this.cells[i]&&this.cells[i][h]){var n=this.cells[i][h];n.discovered?n.visable?t.fillStyle=this.getTempColor(n.tileID):t.fillStyle="#222222":t.fillStyle="#111111"}else t.fillStyle="#111111";t.fillRect(s*e,a*e,e,e),a++}s++}},t.prototype.draw=function(t){this.render_m&&(this.render(this.renderCache.getContext("2d"),GAMEINFO.TILESIZE),this.render_m=!1),t.drawImage(this.renderCache,this.camera.xOffset*GAMEINFO.TILESIZE,this.camera.yOffset*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,0,0,GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE)},t.prototype.drawMiniMap=function(t){this.render_mm&&(this.render(this.MiniMap.getContext("2d"),1),this.render_mm=!1),t.drawImage(this.MiniMap,0,0,this.MiniMap.width,this.MiniMap.height,GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width,0,this.MiniMap.width,this.MiniMap.height),t.strokeStyle="#FFF",t.lineWidth=2,t.strokeRect(GAMEINFO.GAME_PIXEL_WIDTH-this.width+this.camera.xOffset,this.camera.yOffset,this.camera.width,this.camera.height)},t.prototype.drawEntities=function(t){for(var e,i,s,h,a=0,n=this.EntityList;a<n.length;a++){var r=n[a];r.player&&(e=r,i=e.pos.value)}var o,l,c,f,E=4;o=l=c=f=E;for(var I=E;I>=0;I--)for(var d=E;d>=0;d--)if(this.cells[i.x+I]&&this.cells[i.x+I][i.y+d]&&4===this.cells[i.x+I][i.y+d].tileID||this.cells[i.x-I]&&this.cells[i.x-I][i.y+d]&&4===this.cells[i.x-I][i.y+d].tileID||this.cells[i.x+I]&&this.cells[i.x+I][i.y-d]&&4===this.cells[i.x+I][i.y-d].tileID||this.cells[i.x-I]&&this.cells[i.x-I][i.y-d]&&4===this.cells[i.x-I][i.y-d].tileID)for(var u=1;E>u;u++)if(u>=I&&u>=d&&o>u){o=l=c=f=u;break}t.globalAlpha=.1,t.fillStyle="#FFFFFF",t.fillRect((e.pos.value.x-this.camera.xOffset-o)*GAMEINFO.TILESIZE,(e.pos.value.y-this.camera.yOffset-l)*GAMEINFO.TILESIZE,(1+o+c)*GAMEINFO.TILESIZE,(1+l+f)*GAMEINFO.TILESIZE),t.globalAlpha=1;for(var m=0,p=this.EntityList;m<p.length;m++){var r=p[m];s=h=0,r.player?t.fillStyle="#FF6600":(s=e.pos.value.x-r.pos.value.x,h=e.pos.value.y-r.pos.value.y,t.fillStyle="#FF0000");var y=r.components.pos.value;(r.player||s>=-o&&c>=s&&h>=-l&&f>=h)&&(t.fillRect(y.x*GAMEINFO.TILESIZE-this.camera.xOffset*GAMEINFO.TILESIZE,y.y*GAMEINFO.TILESIZE-this.camera.yOffset*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE),t.fillRect(y.x+(GAMEINFO.GAME_PIXEL_WIDTH-this.MiniMap.width),y.y,1,1))}},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Cave=function(t){function e(e,i,s){t.call(this,e,i,s);for(var h=0;h<this.width;h++)for(var a=0;a<this.height;a++)void 0===this.cells[h]&&(this.cells[h]=[]),100*Math.random()<50||0===h||h===this.width-1||0===a||a===this.height-1?this.cells[h][a]=new Cell(0):this.cells[h][a]=new Cell(1);for(var h=5;h<this.width-5;h++)this.cells[h][this.height/2-1].tileID=1,this.cells[h][this.height/2].tileID=1,this.cells[h][this.height/2+1].tileID=1;for(var a=5;a<this.width-5;a++)this.cells[this.height/2-1][a].tileID=1,this.cells[this.height/2][a].tileID=1,this.cells[this.height/2+1][a].tileID=1;this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]);for(var h=1;h<this.width-1;h++)for(var a=1;a<this.height-1;a++){var n=this.cells[h][a],r=this.getLiveNeighbors(h,a);0===n.tileID&&2>r?n.tileID=1:1===n.tileID&&8===r&&(n.tileID=0)}for(var o=this.width/2,l=this.height/2;1!==this.cells[o][l].tileID;)o++;this.floodFill(o,l,1,2);for(var h=1;h<this.width-1;h++)for(var a=1;a<this.height-1;a++)1===this.cells[h][a].tileID&&(this.cells[h][a].tileID=0)}return __extends(e,t),e.prototype.getLiveNeighbors=function(t,e){for(var i=0,s=t-1;t+1>=s;s++)if(!(0>s||s>this.width))for(var h=e-1;e+1>=h;h++)0>h||h>this.height||(s!==t||h!==e)&&(i+=this.cells[s][h].tileID);return 8-i},e.prototype.cellularAutomata=function(t,e){for(var i=1;i<this.width-1;i++)for(var s=1;s<this.height-1;s++){var h=this.cells[i][s],a=this.getLiveNeighbors(i,s);if(1===h.tileID){for(var n in t)if(a===t[n]){h.tileID=0;break}}else{h.tileID=1;for(var n in e)if(a===e[n]){h.tileID=0;break}}}},e}(Level),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},WALL;!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W"}(WALL||(WALL={}));var Room=function(){function t(){this.x=0,this.y=0,this.w=0,this.h=0,this.walls=[WALL.N,WALL.E,WALL.S,WALL.W],shuffle(this.walls)}return t.prototype.getRandomWall=function(){var t,e,i=this.walls.pop();return i===WALL.N?(t=this.x+Math.floor(this.w/2),e=this.y-1):i===WALL.S?(t=this.x+Math.floor(this.w/2),e=this.y+this.h):i===WALL.W?(t=this.x-1,e=this.y+Math.floor(this.h/2)):i===WALL.E&&(t=this.x+this.w,e=this.y+Math.floor(this.h/2)),{x:t,y:e,w:i}},t}(),Dungeon=function(t){function e(e,i,s){t.call(this,e,i,s),this.rooms=[];for(var h=0;h<this.width;h++)for(var a=0;a<this.height;a++)void 0===this.cells[h]&&(this.cells[h]=[]),this.cells[h][a]=new Cell(0);this.generate(32)}return __extends(e,t),e.prototype.scan=function(t,e,i){var s=!0,h=e===WALL.W?t.x-1:t.x,a=e===WALL.N?t.y-1:t.y,n=!i||e!==WALL.W&&e!==WALL.E?t.w:t.w+1,r=!i||e!==WALL.N&&e!==WALL.S?t.h:t.h+1;n=e===WALL.N||e===WALL.S?n+1:n,r=e===WALL.W||e===WALL.E?r+1:r,i&&(h=e===WALL.E?h-1:h,a=e===WALL.S?a-1:a),(e===WALL.N||e===WALL.S)&&(h-=1),(e===WALL.W||e===WALL.E)&&(a-=1);for(var o=h;!(o>h+n)&&s;o++)for(var l=a;!(l>a+r)&&s;l++)s=s&&void 0!==this.cells[o]&&void 0!==this.cells[o][l]&&0===this.cells[o][l].tileID;return s},e.prototype.addRoom=function(t){for(var e=t.x;e<t.x+t.w;e++)for(var i=t.y;i<t.y+t.h;i++)this.cells[e][i].tileID=2},e.prototype.addTile=function(t,e){this.cells[t.x][t.y].tileID=e},e.prototype.makeRoom=function(t,e,i){void 0===t&&(t={x:-1,y:-1,w:-1}),void 0===e&&(e="R"),void 0===i&&(i=!1);var s=new Room;if(s.roomType=e,"R"===e){do s.w=randomInt(5,this.width/5),s.w=s.w%2===0?s.w-1:s.w,s.h=randomInt(5,this.height/5),s.h=s.h%2===0?s.h-1:s.h;while(s.w*s.h>this.width*this.height/4)}else"C"===e&&(s.w=t.w===WALL.N||t.w===WALL.S?3:randomInt(5,9),s.w=s.w%2===0?s.w-1:s.w,s.h=t.w===WALL.W||t.w===WALL.E?3:randomInt(5,9),s.h=s.h%2===0?s.h-1:s.h);if(s.x=t.w===WALL.N||t.w===WALL.S?t.x-Math.floor(s.w/2):t.x,s.x=t.w===WALL.W?s.x-(s.w-1):s.x,s.y=t.w===WALL.W||t.w===WALL.E?t.y-Math.floor(s.h/2):t.y,s.y=t.w===WALL.N?s.y-(s.h-1):s.y,i)switch(t.w){case WALL.N:s.y-=1;break;case WALL.S:s.y+=1;break;case WALL.W:s.x-=1;break;case WALL.E:s.x+=1}return s},e.prototype.generate=function(t){var e=0,i=0,s=[],h="",a="R",n=0,r=randomInt(0,100),o=this.makeRoom();o.x=randomInt(1,Math.floor(this.width-o.w)-1),o.y=randomInt(1,Math.floor(this.height-o.h)-1),s[s.length]=o,this.addRoom(o),this.rooms.push(o),e++,this.entrance={x:o.x+Math.floor(o.w/2),y:o.y+Math.floor(o.h/2)},this.addTile(this.entrance,5);for(var l;s.length>0&&t>e;){h=r>65+i?"C":"R";do{if(n>5||0===n){if(0===s[s.length-1].walls.length&&s.pop(),0===s.length)break;l=s[s.length-1].getRandomWall(),a=s[s.length-1].roomType}o=this.makeRoom(l,h,h!==a),n++}while(!this.scan(o,l.w,h!==a));if(n=0,0===s.length)break;h!==a&&this.addTile(l,3),s[s.length]=o,this.addRoom(o),"C"===h?i+=10:(this.rooms.push(o),e++,i-=10),a=s[s.length-1].roomType,h="",r=randomInt(0,100)}var c=this.rooms[this.rooms.length-1];this.addTile({x:c.x+Math.floor(c.w/2),y:c.y+Math.floor(c.h/2)},6);for(var f=0;f<this.width;f++)for(var E=0;E<this.height;E++)if(2===this.cells[f][E].tileID)for(var I=-1;1>=I;I++)for(var d=-1;1>=d;d++)this.cells[f+I]&&this.cells[f+I][E+d]&&0===this.cells[f+I][E+d].tileID&&(this.cells[f+I][E+d].tileID=4)},e}(Level),Input;!function(t){var e;!function(t){function e(t){return a[t]}function i(t){var e=r[t];return r[t]=!1,e}function s(t){var e=t.which;a[e]=!0,n[e]&&(r[e]=!0),n[e]=!1}function h(t){var e=t.which;a[e]=!1,n[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE"}(t.KEY||(t.KEY={}));for(var a=(t.KEY,[]),n=[],r=[],o=0;256>o;o++)n[o]=!0;t.isDown=e,t.wasDown=i,t.keyDown=s,t.keyUp=h}(e=t.KB||(t.KB={}))}(Input||(Input={}));var Game=function(){function t(t){this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=GAMEINFO.GAME_PIXEL_WIDTH,this.buffer.height=GAMEINFO.GAME_PIXEL_HEIGHT,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1}return t.prototype.init=function(){console.log("Initializing..."),this.level=new Dungeon(160,160,new Camera(GAMEINFO.GAMESCREEN_TILE_WIDTH,GAMEINFO.GAMESCREEN_TILE_HEIGHT)),this.level.floodDiscover(this.level.entrance.x,this.level.entrance.y),this.level.camera.xOffset=this.level.entrance.x-this.level.camera.width/2,this.level.camera.yOffset=this.level.entrance.y-this.level.camera.height/2,this.level.snapCameraToLevel();var t=new ECS.Entity;t.addComponent(new ECS.Components.IsPlayer),t.addComponent(new ECS.Components.TilePos),t.pos.value.x=this.level.entrance.x,t.pos.value.y=this.level.entrance.y,this.level.EntityList.push(t);for(var e=0;20>e;e++){var i=new ECS.Entity;i.addComponent(new ECS.Components.IsEnemy),i.addComponent(new ECS.Components.TilePos);do i.pos.value.x=randomInt(0,159),i.pos.value.y=randomInt(0,159);while(2!==this.level.cells[i.pos.value.x][i.pos.value.y].tileID);this.level.EntityList.push(i)}this.state="MainMenu"},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="Game";break;case"Game":this.deltaPaused>0&&(t-=this.deltaPaused,0>t&&(t=0),this.deltaPaused=0),this.level.update();break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"Game":(this.clearScreen||this.level.redraw)&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=!1),this.level.redraw&&(this.level.draw(this.bufferCtx),this.bufferCtx.fillStyle="#000000",this.bufferCtx.fillRect(0,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,GAMEINFO.TEXTLOG_TILE_WIDTH*GAMEINFO.TILESIZE,this.screen.height),this.bufferCtx.fillStyle="#000000",this.bufferCtx.fillRect(GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,0,this.screen.height,this.screen.width),this.level.drawMiniMap(this.bufferCtx),this.level.drawEntities(this.bufferCtx),this.ctx.drawImage(this.buffer,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),this.level.redraw=!1);break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t.prototype.pause=function(){"Game"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},t.prototype.unpause=function(){"GamePause"===this.state&&(this.state="Game",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0,this.level.redraw=!0)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var t=new Game(document.getElementById("gameCanvas"));t.init(),window.onblur=t.pause.bind(t),window.onfocus=t.unpause.bind(t),t.run()};