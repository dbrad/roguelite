function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,s=0|Math.min(e,i);s=0>=s?1:s;var n=[t.width*s,t.height*s],h=this.offset=[(window.innerWidth-n[0])/2,(window.innerHeight-n[1])/2],l=document.getElementById("stage"),a="translate("+h[0]+"px, "+h[1]+"px) scale("+s+")";l.style.transform=a,l.style.webkitTransform=a}var Input;!function(t){var e;!function(t){function e(t){return h[t]}function i(t){var e=a[t];return a[t]=!1,e}function s(t){var e=t.which;h[e]=!0,l[e]&&(a[e]=!0),l[e]=!1}function n(t){var e=t.which;h[e]=!1,l[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE"}(t.KEY||(t.KEY={}));for(var h=(t.KEY,[]),l=[],a=[],r=0;256>r;r++)l[r]=!0;t.isDown=e,t.wasDown=i,t.keyDown=s,t.keyUp=n}(e=t.KB||(t.KB={}))}(Input||(Input={}));var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},TileSet=function(){function t(){}return t}(),Entity=function(){function t(){this.components={}}return t.prototype.addComponent=function(t){this.components[t.name]=t,this[t.name]=t},t}(),Component=function(){function t(t){this.name=t}return t}(),IsPlayerCom=function(t){function e(){t.call(this,"isPlayer"),this.value=!0}return __extends(e,t),e}(Component),Item=function(){function t(){}return t}(),Cell=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=[]),void 0===i&&(i=null),this.tileID=t,this.entityID=i,this.itemIDs=e,this.visable=!0,this.discovered=!0}return t}(),Level=function(){function t(t,e,i){this.redraw=!0,this.cells=[],this.width=t,this.height=e,this.camera=i;for(var s=0;s<this.width;s++)for(var n=0;n<this.height;n++)void 0===this.cells[s]&&(this.cells[s]=[]),100*Math.random()<50||0===s||s===this.width-1||0===n||n===this.height-1?this.cells[s][n]=new Cell(0):this.cells[s][n]=new Cell(1);for(var s=5;s<this.width-5;s++)this.cells[s][this.height/2-1].tileID=1,this.cells[s][this.height/2].tileID=1,this.cells[s][this.height/2+1].tileID=1;for(var n=5;n<this.width-5;n++)this.cells[this.height/2-1][n].tileID=1,this.cells[this.height/2][n].tileID=1,this.cells[this.height/2+1][n].tileID=1;this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]);for(var s=1;s<this.width-1;s++)for(var n=1;n<this.height-1;n++){var h=this.cells[s][n],l=this.getLiveNeighbors(s,n);0===h.tileID&&2>l?h.tileID=1:1===h.tileID&&8===l&&(h.tileID=0)}for(var a=this.width/2,r=this.height/2;1!==this.cells[a][r].tileID;)a++;this.floodFill(a,r,1,2);for(var s=1;s<this.width-1;s++)for(var n=1;n<this.height-1;n++)1===this.cells[s][n].tileID&&(this.cells[s][n].tileID=0)}return t.prototype.floodFill=function(t,e,i,s){var n=this.width-1,h=this.height-1,l=[],a=0;for(l[0]=[],l[0][0]=t,l[0][1]=e,this.cells[t][e].tileID=s;a>=0;)t=l[a][0],e=l[a][1],a--,t>0&&this.cells[t-1][e].tileID===i&&(this.cells[t-1][e].tileID=s,a++,l[a]||(l[a]=[]),l[a][0]=t-1,l[a][1]=e),n>t&&this.cells[t+1][e].tileID===i&&(this.cells[t+1][e].tileID=s,a++,l[a]||(l[a]=[]),l[a][0]=t+1,l[a][1]=e),e>0&&this.cells[t][e-1].tileID===i&&(this.cells[t][e-1].tileID=s,a++,l[a]||(l[a]=[]),l[a][0]=t,l[a][1]=e-1),h>e&&this.cells[t][e+1].tileID===i&&(this.cells[t][e+1].tileID=s,a++,l[a]||(l[a]=[]),l[a][0]=t,l[a][1]=e+1)},t.prototype.getLiveNeighbors=function(t,e){for(var i=0,s=t-1;t+1>=s;s++)if(!(0>s||s>this.width))for(var n=e-1;e+1>=n;n++)0>n||n>this.height||(s!==t||n!==e)&&(i+=this.cells[s][n].tileID);return 8-i},t.prototype.cellularAutomata=function(t,e){for(var i=1;i<this.width-1;i++)for(var s=1;s<this.height-1;s++){var n=this.cells[i][s],h=this.getLiveNeighbors(i,s);if(1===n.tileID){for(var l in t)if(h===t[l]){n.tileID=0;break}}else{n.tileID=1;for(var l in e)if(h===e[l]){n.tileID=0;break}}}},t.prototype.getWidth=function(){return this.width},t.prototype.getHeight=function(){return this.height},t.prototype.update=function(){Input.KB.isDown(Input.KB.KEY.LEFT)?(this.camera.xOffset+=1,this.redraw=!0):Input.KB.isDown(Input.KB.KEY.RIGHT)&&(this.camera.xOffset-=1,this.redraw=!0),Input.KB.isDown(Input.KB.KEY.UP)?(this.camera.yOffset+=1,this.redraw=!0):Input.KB.isDown(Input.KB.KEY.DOWN)&&(this.camera.yOffset-=1,this.redraw=!0)},t.prototype.draw=function(t){for(var e=this.camera.xOffset,i=0;e<this.camera.xOffset+this.camera.width;e++){for(var s=this.camera.yOffset,n=0;s<this.camera.yOffset+this.camera.height;s++)if(this.cells[e])if(this.cells[e][s]){var h=this.cells[e][s];if(h.discovered)if(h.visable){switch(h.tileID){case 0:t.fillStyle="#000";break;case 1:t.fillStyle="#AAA";break;case 2:t.fillStyle="#0FF";break;default:t.fillStyle="#FFF"}t.fillRect(8*i,8*n,8,8)}else t.fillStyle="#bbb",t.fillRect(8*i,8*n,8,8);else t.fillStyle="black",t.fillRect(8*i,8*n,8,8);n++}else t.fillStyle="#000",t.fillRect(8*i,8*n,8,8),n++;else t.fillStyle="#000",t.fillRect(8*i,8*n,8,8),n++;i++}},t}(),Camera=function(){function t(t,e,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this.width=t,this.height=e,this.xOffset=i,this.yOffset=s}return t}(),GAMEINFO;!function(t){t.GAMESCREEN_TILE_WIDTH=80,t.GAMESCREEN_TILE_HEIGHT=45}(GAMEINFO||(GAMEINFO={}));var Game=function(){function t(t){this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}return t.prototype.init=function(){console.log("Initializing..."),this.level=new Level(100,100,new Camera(GAMEINFO.GAMESCREEN_TILE_WIDTH,GAMEINFO.GAMESCREEN_TILE_HEIGHT)),console.log(this.level.cells),this.state="MainMenu"},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="Game";break;case"Game":this.deltaPaused>0&&(t-=this.deltaPaused,0>t&&(t=0),this.deltaPaused=0),this.level.update();break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"Game":this.clearScreen&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.ctx.fillStyle="#bbb",this.ctx.fillRect(0,360,640,this.screen.height),this.ctx.fillStyle="#ddd",this.ctx.fillRect(640,0,this.screen.height,this.screen.width),this.clearScreen=!1),this.level.redraw&&(this.ctx.clearRect(0,0,8*GAMEINFO.GAMESCREEN_TILE_WIDTH,8*GAMEINFO.GAMESCREEN_TILE_HEIGHT),this.level.draw(this.ctx),this.level.redraw=!1);break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t.prototype.pause=function(){"Game"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},t.prototype.unpause=function(){"GamePause"===this.state&&(this.state="Game",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0,this.level.redraw=!0)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var t=new Game(document.getElementById("gameCanvas"));t.init(),window.onblur=t.pause.bind(t),window.onfocus=t.unpause.bind(t),t.run()};