function randomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}function shuffle(t){for(var e,i,h=t.length;0!==h;)i=Math.floor(Math.random()*h),h-=1,e=t[h],t[h]=t[i],t[i]=e;return t}function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,h=0|Math.min(e,i);h=0>=h?1:h;var s=[t.width*h,t.height*h],n=this.offset=[(window.innerWidth-s[0])/2,(window.innerHeight-s[1])/2],a=document.getElementById("stage"),r="translate("+n[0]+"px, "+n[1]+"px) scale("+h+")";a.style.transform=r,a.style.webkitTransform=r}var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var h in e)e.hasOwnProperty(h)&&(t[h]=e[h]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},GAMEINFO;!function(t){t.TILESIZE=16,t.GAME_PIXEL_WIDTH=800,t.GAME_PIXEL_HEIGHT=448,t.GAME_TILE_WIDTH=t.GAME_PIXEL_WIDTH/t.TILESIZE,t.GAME_TILE_HEIGHT=t.GAME_PIXEL_HEIGHT/t.TILESIZE,t.GAMESCREEN_TILE_WIDTH=40,t.GAMESCREEN_TILE_HEIGHT=22,t.SIDEBAR_TILE_WIDTH=t.GAME_TILE_WIDTH-t.GAMESCREEN_TILE_WIDTH,t.SIDEBAR_TILE_HEIGHT=t.GAME_TILE_HEIGHT,t.TEXTLOG_TILE_WIDTH=t.GAME_TILE_WIDTH-t.SIDEBAR_TILE_WIDTH,t.TEXTLOG_TILE_HEIGHT=t.GAME_TILE_HEIGHT-t.GAMESCREEN_TILE_HEIGHT}(GAMEINFO||(GAMEINFO={}));var TileSet=function(){function t(){}return t}(),Entity=function(){function t(){this.components={}}return t.prototype.addComponent=function(t){this.components[t.name]=t,this[t.name]=t},t}(),Component=function(){function t(t){this.name=t}return t}(),IsPlayerCom=function(t){function e(){t.call(this,"isPlayer"),this.value=!0}return __extends(e,t),e}(Component),Item=function(){function t(){}return t}(),Cell=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=[]),void 0===i&&(i=null),this.tileID=t,this.entityID=i,this.itemIDs=e,this.visable=!0,this.discovered=!0}return t}(),Camera=function(){function t(t,e,i,h){void 0===i&&(i=0),void 0===h&&(h=0),this.width=t,this.height=e,this.xOffset=i,this.yOffset=h}return t}(),Level=function(){function t(t,e,i){this.redraw=!0,this.cells=[],this.width=t,this.height=e,this.camera=i,this.MiniMap=document.createElement("canvas"),this.MiniMap.width=160,this.MiniMap.height=160}return t.prototype.floodFill=function(t,e,i,h){var s=this.width-1,n=this.height-1,a=[],r=0;for(a[0]=[],a[0][0]=t,a[0][1]=e,this.cells[t][e].tileID=h;r>=0;)t=a[r][0],e=a[r][1],r--,t>0&&this.cells[t-1][e].tileID===i&&(this.cells[t-1][e].tileID=h,r++,a[r]||(a[r]=[]),a[r][0]=t-1,a[r][1]=e),s>t&&this.cells[t+1][e].tileID===i&&(this.cells[t+1][e].tileID=h,r++,a[r]||(a[r]=[]),a[r][0]=t+1,a[r][1]=e),e>0&&this.cells[t][e-1].tileID===i&&(this.cells[t][e-1].tileID=h,r++,a[r]||(a[r]=[]),a[r][0]=t,a[r][1]=e-1),n>e&&this.cells[t][e+1].tileID===i&&(this.cells[t][e+1].tileID=h,r++,a[r]||(a[r]=[]),a[r][0]=t,a[r][1]=e+1)},t.prototype.getWidth=function(){return this.width},t.prototype.getHeight=function(){return this.height},t.prototype.update=function(){if(Input.KB.isDown(Input.KB.KEY.LEFT)){if(this.camera.xOffset<=0)return;this.camera.xOffset-=3,this.redraw=!0}else if(Input.KB.isDown(Input.KB.KEY.RIGHT)){if(this.camera.xOffset+this.camera.width>this.width)return;this.camera.xOffset+=3,this.redraw=!0}if(Input.KB.isDown(Input.KB.KEY.UP)){if(this.camera.yOffset<=0)return;this.camera.yOffset-=3,this.redraw=!0}else if(Input.KB.isDown(Input.KB.KEY.DOWN)){if(this.camera.yOffset+this.camera.height>this.height)return;this.camera.yOffset+=3,this.redraw=!0}},t.prototype.draw=function(t){for(var e=this.camera.xOffset,i=0;e<this.camera.xOffset+this.camera.width;e++){for(var h=this.camera.yOffset,s=0;h<this.camera.yOffset+this.camera.height;h++)if(this.cells[e]&&this.cells[e][h]){var n=this.cells[e][h];if(n.discovered)if(n.visable){switch(n.tileID){case 0:t.fillStyle="#333333";break;case 1:t.fillStyle="#AAA";break;case 2:t.fillStyle="#999999";break;default:t.fillStyle="#FFF"}t.fillRect(i*GAMEINFO.TILESIZE,s*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE)}else t.fillStyle="#bbb",t.fillRect(i*GAMEINFO.TILESIZE,s*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE);else t.fillStyle="black",t.fillRect(i*GAMEINFO.TILESIZE,s*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE);s++}else t.fillStyle="#333333",t.fillRect(i*GAMEINFO.TILESIZE,s*GAMEINFO.TILESIZE,GAMEINFO.TILESIZE,GAMEINFO.TILESIZE),s++;i++}},t.prototype.renderMiniMap=function(){for(var t=this.MiniMap.getContext("2d"),e=0,i=0;e<this.width;e++){for(var h=0,s=0;h<this.height;h++)if(this.cells[e])if(this.cells[e][h]){var n=this.cells[e][h];if(n.discovered)if(n.visable){switch(n.tileID){case 0:t.fillStyle="#333333";break;case 1:t.fillStyle="#AAA";break;case 2:t.fillStyle="#999999";break;default:t.fillStyle="#FFF"}t.fillRect(i,s,1,1)}else t.fillStyle="#bbb",t.fillRect(i,s,1,1);else t.fillStyle="black",t.fillRect(i,s,1,1);s++}else t.fillStyle="#333333",t.fillRect(i,s,1,1),s++;else t.fillStyle="#333333",t.fillRect(i,s,1,1),s++;i++}},t.prototype.drawMiniMap=function(t){t.drawImage(this.MiniMap,GAMEINFO.GAME_PIXEL_WIDTH-this.width,GAMEINFO.GAME_PIXEL_HEIGHT-this.height,this.width,this.height,0,0,this.width,this.height),t.strokeStyle="#FFF",t.lineWidth=2,t.strokeRect(GAMEINFO.GAME_PIXEL_WIDTH-this.width+this.camera.xOffset,GAMEINFO.GAME_PIXEL_HEIGHT-this.height+this.camera.yOffset,this.camera.width,this.camera.height)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var h in e)e.hasOwnProperty(h)&&(t[h]=e[h]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Cave=function(t){function e(e,i,h){t.call(this,e,i,h);for(var s=0;s<this.width;s++)for(var n=0;n<this.height;n++)void 0===this.cells[s]&&(this.cells[s]=[]),100*Math.random()<50||0===s||s===this.width-1||0===n||n===this.height-1?this.cells[s][n]=new Cell(0):this.cells[s][n]=new Cell(1);for(var s=5;s<this.width-5;s++)this.cells[s][this.height/2-1].tileID=1,this.cells[s][this.height/2].tileID=1,this.cells[s][this.height/2+1].tileID=1;for(var n=5;n<this.width-5;n++)this.cells[this.height/2-1][n].tileID=1,this.cells[this.height/2][n].tileID=1,this.cells[this.height/2+1][n].tileID=1;this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]),this.cellularAutomata([5,6,7,8],[4,5,6,7,8]);for(var s=1;s<this.width-1;s++)for(var n=1;n<this.height-1;n++){var a=this.cells[s][n],r=this.getLiveNeighbors(s,n);0===a.tileID&&2>r?a.tileID=1:1===a.tileID&&8===r&&(a.tileID=0)}for(var l=this.width/2,o=this.height/2;1!==this.cells[l][o].tileID;)l++;this.floodFill(l,o,1,2);for(var s=1;s<this.width-1;s++)for(var n=1;n<this.height-1;n++)1===this.cells[s][n].tileID&&(this.cells[s][n].tileID=0)}return __extends(e,t),e.prototype.getLiveNeighbors=function(t,e){for(var i=0,h=t-1;t+1>=h;h++)if(!(0>h||h>this.width))for(var s=e-1;e+1>=s;s++)0>s||s>this.height||(h!==t||s!==e)&&(i+=this.cells[h][s].tileID);return 8-i},e.prototype.cellularAutomata=function(t,e){for(var i=1;i<this.width-1;i++)for(var h=1;h<this.height-1;h++){var s=this.cells[i][h],n=this.getLiveNeighbors(i,h);if(1===s.tileID){for(var a in t)if(n===t[a]){s.tileID=0;break}}else{s.tileID=1;for(var a in e)if(n===e[a]){s.tileID=0;break}}}},e}(Level),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var h in e)e.hasOwnProperty(h)&&(t[h]=e[h]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},WALL;!function(t){t[t.N=0]="N",t[t.E=1]="E",t[t.S=2]="S",t[t.W=3]="W"}(WALL||(WALL={}));var Room=function(){function t(){this.x=0,this.y=0,this.w=0,this.h=0,this.walls=[WALL.N,WALL.E,WALL.S,WALL.W],shuffle(this.walls)}return t.prototype.getRandomWall=function(){var t,e,i=this.walls.pop();return i===WALL.N?(t=this.x+Math.floor(this.w/2),e=this.y-1):i===WALL.S?(t=this.x+Math.floor(this.w/2),e=this.y+this.h):i===WALL.W?(t=this.x-1,e=this.y+Math.floor(this.h/2)):i===WALL.E&&(t=this.x+this.w,e=this.y+Math.floor(this.h/2)),{x:t,y:e,w:i}},t}(),Dungeon=function(t){function e(e,i,h){t.call(this,e,i,h);for(var s=0;s<this.width;s++)for(var n=0;n<this.height;n++)void 0===this.cells[s]&&(this.cells[s]=[]),this.cells[s][n]=new Cell(0);this.generate(32)}return __extends(e,t),e.prototype.scan=function(t,e,i){var h=!0,s=e===WALL.W?t.x-1:t.x,n=e===WALL.N?t.y-1:t.y,a=!i||e!==WALL.W&&e!==WALL.E?t.w:t.w+1,r=!i||e!==WALL.N&&e!==WALL.S?t.h:t.h+1;a=e===WALL.N||e===WALL.S?a+1:a,r=e===WALL.W||e===WALL.E?r+1:r,i&&(s=e===WALL.E?s-1:s,n=e===WALL.S?n-1:n),(e===WALL.N||e===WALL.S)&&(s-=1),(e===WALL.W||e===WALL.E)&&(n-=1);for(var l=s;!(l>s+a)&&h;l++)for(var o=n;!(o>n+r)&&h;o++)h=h&&void 0!==this.cells[l]&&void 0!==this.cells[l][o]&&0===this.cells[l][o].tileID;return h},e.prototype.addRoom=function(t){for(var e=t.x;e<t.x+t.w;e++)for(var i=t.y;i<t.y+t.h;i++)this.cells[e][i].tileID=2},e.prototype.addDoor=function(t){this.cells[t.x][t.y].tileID=3},e.prototype.makeRoom=function(t,e){void 0===t&&(t={x:-1,y:-1,w:-1}),void 0===e&&(e=!0);var i=new Room;do i.w=randomInt(5,this.width/5),i.w=i.w%2===0?i.w-1:i.w,i.h=randomInt(5,this.height/5),i.h=i.h%2===0?i.h-1:i.h;while(i.w*i.h>this.width*this.height/4);if(i.x=t.w===WALL.N||t.w===WALL.S?t.x-Math.floor(i.w/2):t.x,i.x=t.w===WALL.W?i.x-(i.w-1):i.x,i.y=t.w===WALL.W||t.w===WALL.E?t.y-Math.floor(i.h/2):t.y,i.y=t.w===WALL.N?i.y-(i.h-1):i.y,!e)switch(t.w){case WALL.N:i.y-=1;break;case WALL.S:i.y+=1;break;case WALL.W:i.x-=1;break;case WALL.E:i.x+=1}return i},e.prototype.makeCorridor=function(t,e){void 0===t&&(t={x:-1,y:-1,w:-1}),void 0===e&&(e=!0);var i=new Room;if(i.w=t.w===WALL.N||t.w===WALL.S?3:randomInt(5,9),i.w=i.w%2===0?i.w-1:i.w,i.h=t.w===WALL.W||t.w===WALL.E?3:randomInt(5,9),i.h=i.h%2===0?i.h-1:i.h,i.x=t.w===WALL.N||t.w===WALL.S?t.x-Math.floor(i.w/2):t.x,i.x=t.w===WALL.W?i.x-(i.w-1):i.x,i.y=t.w===WALL.W||t.w===WALL.E?t.y-Math.floor(i.h/2):t.y,i.y=t.w===WALL.N?i.y-(i.h-1):i.y,e)switch(t.w){case WALL.N:i.y-=1;break;case WALL.S:i.y+=1;break;case WALL.W:i.x-=1;break;case WALL.E:i.x+=1}return i},e.prototype.generate=function(t){var e=[],i=0,h=0,s=!0,n=0,a=randomInt(0,100),r=this.makeRoom();r.x=Math.floor(this.width/2-r.w/2),r.y=Math.floor(this.height/2-r.h/2),e[e.length]=r,this.addRoom(r),i++;for(var l;e.length>0&&t>i;){if(a>65+h){do{if(n>5||0===n){if(0===e[e.length-1].walls.length&&e.pop(),0===e.length)break;l=e[e.length-1].getRandomWall()}r=this.makeCorridor(l,s),n++}while(!this.scan(r,l.w,s));if(n=0,0===e.length)break;s&&this.addDoor(l),e[e.length]=r,this.addRoom(r),h+=10,s=!1}else{do{if(n>5||0===n){if(0===e[e.length-1].walls.length&&e.pop(),0===e.length)break;l=e[e.length-1].getRandomWall()}r=this.makeRoom(l,s),n++}while(!this.scan(r,l.w,!s));if(n=0,0===e.length)break;s||this.addDoor(l),e[e.length]=r,this.addRoom(r),i++,h-=10,s=!0}a=randomInt(0,100)}},e}(Level),Input;!function(t){var e;!function(t){function e(t){return n[t]}function i(t){var e=r[t];return r[t]=!1,e}function h(t){var e=t.which;n[e]=!0,a[e]&&(r[e]=!0),a[e]=!1}function s(t){var e=t.which;n[e]=!1,a[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE"}(t.KEY||(t.KEY={}));for(var n=(t.KEY,[]),a=[],r=[],l=0;256>l;l++)a[l]=!0;t.isDown=e,t.wasDown=i,t.keyDown=h,t.keyUp=s}(e=t.KB||(t.KB={}))}(Input||(Input={}));var Game=function(){function t(t){this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1,this.buffer=document.createElement("canvas"),this.buffer.width=GAMEINFO.GAME_PIXEL_WIDTH,this.buffer.height=GAMEINFO.GAME_PIXEL_HEIGHT,this.bufferCtx=this.buffer.getContext("2d"),this.bufferCtx.mozImageSmoothingEnabled=!1,this.bufferCtx.imageSmoothingEnabled=!1}return t.prototype.init=function(){console.log("Initializing..."),this.level=new Dungeon(160,160,new Camera(GAMEINFO.GAMESCREEN_TILE_WIDTH,GAMEINFO.GAMESCREEN_TILE_HEIGHT)),this.state="MainMenu"},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="Game";break;case"Game":this.deltaPaused>0&&(t-=this.deltaPaused,0>t&&(t=0),this.deltaPaused=0),this.level.update();break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"Game":this.clearScreen&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.ctx.fillStyle="#bbb",this.ctx.fillRect(0,GAMEINFO.GAMESCREEN_TILE_HEIGHT*GAMEINFO.TILESIZE,GAMEINFO.TEXTLOG_TILE_WIDTH*GAMEINFO.TILESIZE,this.screen.height),this.ctx.fillStyle="#ddd",this.ctx.fillRect(GAMEINFO.GAMESCREEN_TILE_WIDTH*GAMEINFO.TILESIZE,0,this.screen.height,this.screen.width),this.level.renderMiniMap(),this.clearScreen=!1),this.level.redraw&&(this.level.draw(this.bufferCtx),this.level.drawMiniMap(this.bufferCtx),this.ctx.drawImage(this.buffer,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT,0,0,GAMEINFO.GAME_PIXEL_WIDTH,GAMEINFO.GAME_PIXEL_HEIGHT),this.level.redraw=!1);break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t.prototype.pause=function(){"Game"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},t.prototype.unpause=function(){"GamePause"===this.state&&(this.state="Game",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0,this.level.redraw=!0)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var t=new Game(document.getElementById("gameCanvas"));t.init(),window.onblur=t.pause.bind(t),window.onfocus=t.unpause.bind(t),t.run()};